<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>수학 풀이 코칭 v0.4</title>

  <!-- PWA 연결: GitHub Pages 하위 경로(/math-coach/) 기준 -->
  <link rel="manifest" href="/math-coach/manifest.json">
  <meta name="theme-color" content="#0f1220">

  <!-- OCR: Tesseract.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root { --bg:#0f1220; --card:#171a2b; --accent:#6ea8fe; --text:#e9edf5; --muted:#9aa3b2; --ok:#4ade80; --warn:#fbbf24; --bad:#f87171; }
    *{box-sizing:border-box;font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text)}
    header{padding:16px 20px;border-bottom:1px solid #23263a}
    header h1{margin:0;font-size:20px}
    header p{margin:6px 0 0;color:var(--muted);font-size:13px}
    .container{max-width:920px;margin:0 auto;padding:16px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .tab{flex:1;min-width:180px;background:var(--card);border:1px solid #23263a;padding:10px 12px;border-radius:10px;cursor:pointer;text-align:center;color:var(--muted)}
    .tab.active{outline:2px solid var(--accent);color:var(--text)}
    .card{background:var(--card);border:1px solid #23263a;border-radius:12px;padding:16px;margin-bottom:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{flex:1;min-width:220px}
    label{display:block;margin:8px 0 4px;color:#c7cede;font-size:13px}
    input, select{width:100%;padding:10px;border-radius:8px;border:1px solid #2a2e44;background:#121428;color:var(--text)}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    button{padding:10px 12px;border:1px solid #2a2e44;background:#121428;color:var(--text);border-radius:8px;cursor:pointer}
    button.primary{background:var(--accent);border-color:var(--accent);color:#0b1020}
    .hint{background:#101325;border-left:4px solid #6ea8fe;padding:10px 12px;border-radius:8px;margin:8px 0}
    .muted{color:var(--muted);font-size:13px}
    .ok{color:var(--ok);font-weight:600}
    .bad{color:var(--bad);font-weight:600}
    .warn{color:var(--warn);font-weight:600}
    .steps ol{margin:10px 0 0 18px}
    .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #2a2e44;background:#0f1220;color:#cfd6ea}
    footer{padding:16px 20px;color:#9aa3b2;font-size:12px;border-top:1px solid #23263a}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:800px){.grid{grid-template-columns:1fr}}
    .small{font-size:12px;color:#9aa3b2}
    .progress{height:6px;background:#0b1020;border-radius:999px;overflow:hidden;margin-top:8px}
    .bar{height:100%;width:0;background:#6ea8fe;transition:width .2s}

    /* 미리보기 + 선택 박스(크롭) */
    #preview-wrap{position:relative;background:#0b1020;border:1px solid #23263a;border-radius:10px;padding:10px}
    #img-preview{max-width:100%;display:none;border-radius:8px}
    #crop-box{position:absolute;border:2px dashed #6ea8fe;background:rgba(110,168,254,.15);display:none;pointer-events:none}
    .crop-btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  </style>
</head>
<body>
<header>
  <h1>수학 풀이 코칭 v0.4</h1>
  <p>사진 → 문제 영역 선택(자르기) → 글자 인식(OCR) → 수식 변환 → 단계 풀이/검산. <span class="badge">학습 보조용</span></p>
</header>

<div class="container">

  <!-- 사진으로 입력 + 영역 선택 -->
  <section class="card" id="camera-input">
    <h3>사진으로 입력(카메라/앨범) + 문제 영역 선택</h3>
    <div class="row">
      <div class="col">
        <input id="img-file" type="file" accept="image/*" capture="environment">
        <div id="preview-wrap" style="margin-top:10px">
          <img id="img-preview" alt="미리보기">
          <div id="crop-box"></div>
        </div>
        <div class="crop-btns">
          <button id="btn-ocr-all">전체 인식</button>
          <button id="btn-ocr-crop" class="primary">선택 영역만 인식</button>
          <button id="btn-ocr-clear">선택 초기화</button>
        </div>
        <div class="progress"><div class="bar" id="ocr-bar"></div></div>
        <p class="small">팁: 문제식만 보이게 네모로 드래그해 선택하세요. 인쇄물·밝은 사진일수록 인식률이 높아요.</p>
      </div>
      <div class="col">
        <label>인식된 텍스트(검토/수정 가능)</label>
        <input id="ocr-text" placeholder="예: 2x+3=11  /  x^2-5x+6=0  /  2x+y=11, x+y=8">
        <div class="btns">
          <select id="qi-type">
            <option value="auto">자동 판별</option>
            <option value="linear">1차 방정식</option>
            <option value="quadratic">이차 방정식(=0)</option>
            <option value="system">연립(2×2)</option>
          </select>
          <button id="qi-fill" class="primary">채우고 풀이로 이동</button>
        </div>
      </div>
    </div>
  </section>

  <!-- 텍스트 빠른 입력 -->
  <section class="card" id="quick-input">
    <h3>텍스트로 빠르게 입력</h3>
    <div class="row">
      <div class="col">
        <label>유형</label>
        <select id="qi-type2">
          <option value="linear">1차 방정식</option>
          <option value="quadratic">이차 방정식(=0 형태)</option>
          <option value="system">연립방정식(2×2)</option>
        </select>
      </div>
      <div class="col">
        <label>수식</label>
        <input id="qi-text" placeholder="예: 2x+3=11 / x^2-5x+6=0 / 2x+y=11, x+y=8">
      </div>
    </div>
    <div class="btns">
      <button id="qi-fill2" class="primary">채우기</button>
    </div>
  </section>

  <!-- 탭 -->
  <div class="tabs">
    <div class="tab active" data-tab="linear">1차 방정식</div>
    <div class="tab" data-tab="quadratic">이차 방정식</div>
    <div class="tab" data-tab="system">연립방정식(2×2)</div>
  </div>

  <!-- 1차 방정식 -->
  <section class="card" id="linear">
    <h3>형식: a·x + b = c</h3>
    <div class="grid">
      <div class="col">
        <label>a</label><input id="lin-a" type="number" value="2">
        <label>b</label><input id="lin-b" type="number" value="3">
        <label>c</label><input id="lin-c" type="number" value="11">
        <div class="btns">
          <button class="primary" id="lin-step1">단계 1 보기</button>
          <button id="lin-step2">단계 2 보기</button>
          <button id="lin-answer">정답 보기</button>
          <button id="lin-verify">검산하기</button>
          <button id="lin-reset">초기화</button>
        </div>
        <p class="muted">힌트를 순서대로 보셔야 정답 버튼이 열립니다.</p>
      </div>
      <div class="col steps" id="lin-steps">
        <div class="hint">예: 2x+3=11 → x는 무엇일까요?</div>
        <ol></ol>
        <div id="lin-result"></div>
      </div>
    </div>
  </section>

  <!-- 이차 방정식 -->
  <section class="card" id="quadratic" style="display:none">
    <h3>형식: a·x² + b·x + c = 0</h3>
    <div class="grid">
      <div class="col">
        <label>a</label><input id="quad-a" type="number" value="1">
        <label>b</label><input id="quad-b" type="number" value="-5">
        <label>c</label><input id="quad-c" type="number" value="6">
        <div class="btns">
          <button class="primary" id="quad-step1">단계 1 보기</button>
          <button id="quad-step2">단계 2 보기</button>
          <button id="quad-answer">정답 보기</button>
          <button id="quad-verify">검산하기</button>
          <button id="quad-reset">초기화</button>
        </div>
        <p class="muted">판별식→근의 공식→검산 순으로 진행됩니다.</p>
      </div>
      <div class="col steps" id="quad-steps">
        <div class="hint">예: x²−5x+6=0 → 근을 구해 봅시다.</div>
        <ol></ol>
        <div id="quad-result"></div>
      </div>
    </div>
  </section>

  <!-- 연립방정식 -->
  <section class="card" id="system" style="display:none">
    <h3>형식: a₁x + b₁y = c₁, a₂x + b₂y = c₂</h3>
    <div class="grid">
      <div class="col">
        <label>a₁</label><input id="sys-a1" type="number" value="2">
        <label>b₁</label><input id="sys-b1" type="number" value="1">
        <label>c₁</label><input id="sys-c1" type="number" value="11">
      </div>
      <div class="col">
        <label>a₂</label><input id="sys-a2" type="number" value="1">
        <label>b₂</label><input id="sys-b2" type="number" value="1">
        <label>c₂</label><input id="sys-c2" type="number" value="8">
      </div>
    </div>
    <div class="btns" style="margin-top:8px">
      <button class="primary" id="sys-step1">단계 1 보기</button>
      <button id="sys-step2">단계 2 보기</button>
      <button id="sys-answer">정답 보기</button>
      <button id="sys-verify">검산하기</button>
      <button id="sys-reset">초기화</button>
    </div>
    <p class="muted">Cramer의 공식(Δ, Δx, Δy)으로 풉니다.</p>
    <div class="steps" id="sys-steps" style="margin-top:8px">
      <div class="hint">예: 2x+y=11, x+y=8</div>
      <ol></ol>
      <div id="sys-result"></div>
    </div>
  </section>

  <section class="card">
    <strong>유의:</strong> 본 앱은 학습 보조용입니다. 힌트를 거치지 않으면 정답을 열 수 없으며, 검산을 통과해야 완료로 표시됩니다.
  </section>
</div>

<footer>
  © 학습 코칭용 데모. 개인정보를 수집하지 않습니다. <a href="/math-coach/privacy.html" style="color:#6ea8fe">개인정보처리방침</a>
</footer>

<script>
  // 탭 전환
  document.querySelectorAll('.tab').forEach(t=>{
    t.addEventListener('click', ()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const tab = t.dataset.tab;
      ['linear','quadratic','system'].forEach(id=>{
        document.getElementById(id).style.display = (id===tab)?'block':'none';
      });
    });
  });

  // 공용 유틸
  const gcd=(a,b)=>{a=Math.abs(a);b=Math.abs(b);while(b){[a,b]=[b,a%b]}return a||1};
  const isInt=(v)=>Number.isInteger(v);
  const sgn=(n)=> n>=0?'+':'-';
  const simpFrac=(num,den)=>{
    if(den===0) return '정의되지 않음';
    if(num===0) return '0';
    const g=gcd(num,den);
    num/=g; den/=g;
    if(den<0){den*=-1;num*=-1}
    return (den===1)? `${num}` : `${num}/${den}`;
  };
  const fmtExprLinear=(a,b,c)=>{
    const aStr = (a===1)?'x':(a===-1)?'-x':`${a}x`;
    const bStr = b===0?'':` ${sgn(b)} ${Math.abs(b)}`;
    return `${aStr}${bStr} = ${c}`;
  };

  // 상태(힌트 잠금)
  let gate = {
    lin: {s1:false,s2:false,ans:false},
    quad:{s1:false,s2:false,ans:false},
    sys: {s1:false,s2:false,ans:false}
  };

  // 1차 방정식
  const linStepsOl = document.querySelector('#lin-steps ol');
  const linResult = document.getElementById('lin-result');
  const linReset = ()=>{
    linStepsOl.innerHTML = '';
    linResult.innerHTML = '';
    gate.lin = {s1:false,s2:false,ans:false};
  };
  document.getElementById('lin-reset').onclick = linReset;

  document.getElementById('lin-step1').onclick = ()=>{
    const a=+document.getElementById('lin-a').value;
    const b=+document.getElementById('lin-b').value;
    const c=+document.getElementById('lin-c').value;
    if(a===0){alert('a=0이면 1차 방정식이 아닙니다.');return;}
    linStepsOl.innerHTML = '';
    const li1=document.createElement('li');
    li1.textContent = `표준형으로 정리: ${fmtExprLinear(a,b,c)}`;
    linStepsOl.appendChild(li1);
    const li2=document.createElement('li');
    li2.textContent = `상수항을 이항: ${a}x = ${c} ${b>=0?'-':'+'} ${Math.abs(b)} ⇒ ${a}x = ${c-b}`;
    linStepsOl.appendChild(li2);
    gate.lin.s1 = true;
    gate.lin.s2 = false; gate.lin.ans = false;
    linResult.innerHTML = '';
  };

  document.getElementById('lin-step2').onclick = ()=>{
    if(!gate.lin.s1){alert('먼저 단계 1을 보세요.');return;}
    const a=+document.getElementById('lin-a').value;
    const b=+document.getElementById('lin-b').value;
    const c=+document.getElementById('lin-c').value;
    const num = (c-b), den = a;
    const li3=document.createElement('li');
    li3.textContent = `양변을 ${a}로 나눔: x = (${c} - ${b}) / ${a} = ${simpFrac(num,den)}`;
    linStepsOl.appendChild(li3);
    gate.lin.s2 = true; gate.lin.ans = false;
  };

  document.getElementById('lin-answer').onclick = ()=>{
    if(!(gate.lin.s1 && gate.lin.s2)){alert('힌트를 모두 본 뒤 정답을 확인할 수 있습니다.');return;}
    const a=+document.getElementById('lin-a').value;
    const b=+document.getElementById('lin-b').value;
    const c=+document.getElementById('lin-c').value;
    const num = (c-b), den = a;
    const x = num/den;
    linResult.innerHTML = `<div class="hint"><strong>정답:</strong> x = ${simpFrac(num,den)} ${!isInt(x)?`(≈ ${x.toFixed(6)})`:''}</div>`;
    gate.lin.ans = true;
  };

  document.getElementById('lin-verify').onclick = ()=>{
    if(!gate.lin.ans){alert('정답 확인 후 검산하세요.');return;}
    const a=+document.getElementById('lin-a').value;
    const b=+document.getElementById('lin-b').value;
    const c=+document.getElementById('lin-c').value;
    const x = (c-b)/a;
    const lhs = a*x + b;
    const ok = Math.abs(lhs - c) < 1e-9;
    linResult.innerHTML += `<div class="hint">${ok?'<span class="ok">검산 통과</span>':'<span class="bad">검산 실패</span>'} — 좌변 a·x+b = ${lhs.toFixed(6)}, 우변 = ${c}</div>`;
  };

  // 이차 방정식
  const quadOl = document.querySelector('#quad-steps ol');
  const quadResult = document.getElementById('quad-result');
  const isPerfectSquare = (n)=> n>=0 && Number.isInteger(Math.sqrt(n));
  const quadReset = ()=>{quadOl.innerHTML=''; quadResult.innerHTML=''; gate.quad={s1:false,s2:false,ans:false};};
  document.getElementById('quad-reset').onclick = quadReset;

  document.getElementById('quad-step1').onclick = ()=>{
    const a=+document.getElementById('quad-a').value;
    const b=+document.getElementById('quad-b').value;
    const c=+document.getElementById('quad-c').value;
    if(a===0){alert('a=0이면 이차 방정식이 아닙니다.');return;}
    quadOl.innerHTML='';
    const li1=document.createElement('li');
    li1.textContent = `표준형 확인: ${a===1?'':a+'·'}x² ${b>=0?'+':'-'} ${Math.abs(b)}·x ${c>=0?'+':'-'} ${Math.abs(c)} = 0`;
    quadOl.appendChild(li1);
    const D = b*b - 4*a*c;
    const li2=document.createElement('li');
    li2.textContent = `판별식 D = b² - 4ac = ${b}² - 4·${a}·${c} = ${D}`;
    quadOl.appendChild(li2);
    gate.quad.s1=true; gate.quad.s2=false; gate.quad.ans=false;
    quadResult.innerHTML='';
  };

  document.getElementById('quad-step2').onclick = ()=>{
    if(!gate.quad.s1){alert('먼저 단계 1을 보세요.');return;}
    const a=+document.getElementById('quad-a').value;
    const b=+document.getElementById('quad-b').value;
    const c=+document.getElementById('quad-c').value;
    const D = b*b - 4*a*c;
    const li3=document.createElement('li');
    if(D>0){
      li3.textContent = '실수의 서로 다른 두 근(±)이 존재합니다.';
    }else if(D===0){
      li3.textContent = '중근(한 근)이 존재합니다.';
    }else{
      li3.textContent = '실수근이 없고 서로 다른 두 허근이 존재합니다.';
    }
    quadOl.appendChild(li3);
    gate.quad.s2=true; gate.quad.ans=false;
  };

  document.getElementById('quad-answer').onclick = ()=>{
    if(!(gate.quad.s1 && gate.quad.s2)){alert('힌트를 모두 본 뒤 정답을 확인할 수 있습니다.');return;}
    const a=+document.getElementById('quad-a').value;
    const b=+document.getElementById('quad-b').value;
    const c=+document.getElementById('quad-c').value;
    const D = b*b - 4*a*c;
    let html = '<div class="hint"><strong>정답:</strong> ';
    if(D>=0){
      const sqrtD = Math.sqrt(D);
      const exact = isPerfectSquare(D)
        ? `x = (${ -b } ± ${ sqrtD }) / ${2*a}`
        : `x = (${ -b } ± √${D}) / ${2*a}`;
      let approx = '';
      if(a!==0){
        const x1 = (-b + Math.sqrt(Math.abs(D))) / (2*a);
        const x2 = (-b - Math.sqrt(Math.abs(D))) / (2*a);
        approx = ` ⇒ x ≈ ${x1.toFixed(6)}, ${x2.toFixed(6)}`;
      }
      html += `${exact}${approx}</div>`;
    }else{
      html += `x = (${ -b } ± i·√${-D}) / ${2*a}</div>`;
      html += `<div class="hint">허근 형태(복소수). a≠0, D<0이므로 실수해는 없습니다.</div>`;
    }
    quadResult.innerHTML = html;
    gate.quad.ans = true;
  };

  document.getElementById('quad-verify').onclick = ()=>{
    if(!gate.quad.ans){alert('정답 확인 후 검산하세요.');return;}
    const a=+document.getElementById('quad-a').value;
    const b=+document.getElementById('quad-b').value;
    const c=+document.getElementById('quad-c').value;
    const D = b*b - 4*a*c;
    if(D<0){quadResult.innerHTML += `<div class="hint warn">실수근이 없어 실수 범위 검산은 해당 없음.</div>`; return;}
    const x1 = (-b + Math.sqrt(D)) / (2*a);
    const x2 = (-b - Math.sqrt(D)) / (2*a);
    const f=(x)=> a*x*x + b*x + c;
    const ok1 = Math.abs(f(x1))<1e-6;
    const ok2 = Math.abs(f(x2))<1e-6;
    quadResult.innerHTML += `<div class="hint">${ok1&&ok2?'<span class="ok">검산 통과</span>':'<span class="bad">검산 확인 필요</span>'} — f(x1)=${f(x1).toExponential(2)}, f(x2)=${f(x2).toExponential(2)}</div>`;
  };

  // 연립방정식(2×2)
  const sysOl = document.querySelector('#sys-steps ol');
  const sysResult = document.getElementById('sys-result');
  const sysReset = ()=>{sysOl.innerHTML=''; sysResult.innerHTML=''; gate.sys={s1:false,s2:false,ans:false};};
  document.getElementById('sys-reset').onclick = sysReset;

  document.getElementById('sys-step1').onclick = ()=>{
    const a1=+document.getElementById('sys-a1').value;
    const b1=+document.getElementById('sys-b1').value;
    const c1=+document.getElementById('sys-c1').value;
    const a2=+document.getElementById('sys-a2').value;
    const b2=+document.getElementById('sys-b2').value;
    const c2=+document.getElementById('sys-c2').value;
    sysOl.innerHTML='';
    const li1=document.createElement('li');
    li1.textContent = `표준형 확인: ${a1}x ${sgn(b1)} ${Math.abs(b1)}y = ${c1},  ${a2}x ${sgn(b2)} ${Math.abs(b2)}y = ${c2}`;
    sysOl.appendChild(li1);
    const Δ = a1*b2 - b1*a2;
    const li2=document.createElement('li');
    li2.textContent = `Δ = a₁b₂ − b₁a₂ = ${a1}·${b2} − ${b1}·${a2} = ${Δ}`;
    sysOl.appendChild(li2);
    gate.sys.s1=true; gate.sys.s2=false; gate.sys.ans=false;
    sysResult.innerHTML='';
  };

  document.getElementById('sys-step2').onclick = ()=>{
    if(!gate.sys.s1){alert('먼저 단계 1을 보세요.');return;}
    const a1=+document.getElementById('sys-a1').value;
    const b1=+document.getElementById('sys-b1').value;
    const c1=+document.getElementById('sys-c1').value;
    const a2=+document.getElementById('sys-a2').value;
    const b2=+document.getElementById('sys-b2').value;
    const c2=+document.getElementById('sys-c2').value;
    const Δ = a1*b2 - b1*a2;
    const li3=document.createElement('li');
    if(Δ===0){
      li3.innerHTML = 'Δ=0 → 해가 하나로 정해지지 않습니다(무수히 많거나, 모순으로 해가 없을 수 있음).';
    }else{
      li3.textContent = 'Δ≠0 → 유일해가 존재합니다. 다음 단계로 진행합니다.';
    }
    sysOl.appendChild(li3);
    gate.sys.s2=true; gate.sys.ans=false;
  };

  document.getElementById('sys-answer').onclick = ()=>{
    if(!(gate.sys.s1 && gate.sys.s2)){alert('힌트를 모두 본 뒤 정답을 확인할 수 있습니다.');return;}
    const a1=+document.getElementById('sys-a1').value;
    const b1=+document.getElementById('sys-b1').value;
    const c1=+document.getElementById('sys-c1').value;
    const a2=+document.getElementById('sys-a2').value;
    const b2=+document.getElementById('sys-b2').value;
    const c2=+document.getElementById('sys-c2').value;
    const Δ = a1*b2 - b1*a2;
    if(Δ===0){ sysResult.innerHTML = '<div class="hint warn">Δ=0 상태 — 유일해 없음(특수 케이스)</div>'; return; }
    const Δx = c1*b2 - b1*c2;
    const Δy = a1*c2 - c1*a2;
    const xStr = simpFrac(Δx, Δ);
    const yStr = simpFrac(Δy, Δ);
    const x=Δx/Δ, y=Δy/Δ;
    sysResult.innerHTML = `<div class="hint"><strong>정답:</strong> x = ${xStr}, y = ${yStr} (x≈${x.toFixed(6)}, y≈${y.toFixed(6)})</div>
      <div class="hint">Cramer: x=Δx/Δ, y=Δy/Δ where Δ=${Δ}, Δx=${Δx}, Δy=${Δy}</div>`;
    gate.sys.ans=true;
  };

  document.getElementById('sys-verify').onclick = ()=>{
    if(!gate.sys.ans){alert('정답 확인 후 검산하세요.');return;}
    const a1=+document.getElementById('sys-a1').value;
    const b1=+document.getElementById('sys-b1').value;
    const c1=+document.getElementById('sys-c1').value;
    const a2=+document.getElementById('sys-a2').value;
    const b2=+document.getElementById('sys-b2').value;
    const c2=+document.getElementById('sys-c2').value;
    const Δ = a1*b2 - b1*a2;
    if(Δ===0){ return; }
    const x=(c1*b2 - b1*c2)/Δ;
    const y=(a1*c2 - c1*a2)/Δ;
    const ok1 = Math.abs(a1*x + b1*y - c1)<1e-9;
    const ok2 = Math.abs(a2*x + b2*y - c2)<1e-9;
    sysResult.innerHTML += `<div class="hint">${(ok1&&ok2)?'<span class="ok">검산 통과</span>':'<span class="bad">검산 실패</span>'} — 식1: ${ (a1*x + b1*y).toFixed(6)} vs ${c1}, 식2: ${(a2*x + b2*y).toFixed(6)} vs ${c2}</div>`;
  };

  // ===== 텍스트 자동 파서 + OCR + 크롭(선택 영역) =====
  (function(){
    const $ = sel => document.querySelector(sel);
    const tabs = document.querySelectorAll('.tab');
    function activateTab(id){
      tabs.forEach(t=>{ t.classList.toggle('active', t.dataset.tab===id); });
      ['linear','quadratic','system'].forEach(s=>{
        document.getElementById(s).style.display = (s===id)?'block':'none';
      });
    }
    function clean(s){
      return s
        .replace(/\s+/g,'')
        .replace(/[−–—]/g,'-')
        .replace(/[·×]/g,'*')
        .replace(/[＝=]/g,'=')
        .replace(/[Ⅰl]/g,'1')
        .replace(/Ｏ/g,'0')
        .toLowerCase();
    }
    function parseCoeff(raw){
      if(raw==null) return 0;
      if(raw===''||raw==='+') return 1;
      if(raw==='-') return -1;
      return parseFloat(raw);
    }
    function parseLinear(str){
      str=clean(str);
      const m = str.match(/^([+\-]?\d*)x(?:([+\-]\d+))?=([+\-]?\d+(?:\.\d+)?)$/);
      if(!m) return null;
      const a = parseCoeff(m[1]??'');
      const b = m[2]? parseFloat(m[2].replace('+','')):0;
      const c = parseFloat(m[3]);
      return {a,b,c};
    }
    function parseQuadratic(str){
      str=clean(str).replace(/x\^2/g,'x2');
      const m = str.match(/^([+\-]?\d*)x2([+\-]\d*)x([+\-]\d+)=0$/);
      if(!m) return null;
      const a = parseCoeff(m[1]??'');
      const b = parseCoeff(m[2]??'');
      const c = parseFloat(m[3]);
      return {a,b,c};
    }
    function parseEq2(eq){
      eq=clean(eq);
      const mx = eq.match(/([+\-]?\d*)x/);
      const my = eq.match(/([+\-]?\d*)y/);
      const mr = eq.match(/=([+\-]?\d+(?:\.\d+)?)/);
      if(!mx || !my || !mr) return null;
      const a = parseCoeff(mx[1]??'');
      const b = parseCoeff(my[1]??'');
      const c = parseFloat(mr[1]);
      return {a,b,c};
    }
    function parseSystem(str){
      const parts = clean(str).split(/[,;]|(?:\r?\n)/).filter(Boolean);
      if(parts.length!==2) return null;
      const e1=parseEq2(parts[0]); const e2=parseEq2(parts[1]);
      if(!e1||!e2) return null;
      return {a1:e1.a,b1:e1.b,c1:e1.c,a2:e2.a,b2:e2.b,c2:e2.c};
    }
    function fillLinear(v){ $('#lin-a').value=v.a; $('#lin-b').value=v.b; $('#lin-c').value=v.c; }
    function fillQuadratic(v){ $('#quad-a').value=v.a; $('#quad-b').value=v.b; $('#quad-c').value=v.c; }
    function fillSystem(v){ $('#sys-a1').value=v.a1; $('#sys-b1').value=v.b1; $('#sys-c1').value=v.c1; $('#sys-a2').value=v.a2; $('#sys-b2').value=v.b2; $('#sys-c2').value=v.c2; }
    function autoDetect(text){
      const s = clean(text);
      if (/[,;\n]/.test(s) && /y/.test(s)) return 'system';
      if (/x2|x\^2/.test(s)) return 'quadratic';
      return 'linear';
    }

    // OCR 공통
    const fileInput = $('#img-file');
    const bar = $('#ocr-bar');
    const img = $('#img-preview');
    const cropBox = $('#crop-box');
    let imgFile = null, imgLoaded = false;
    let imgNaturalW = 0, imgNaturalH = 0;

    // 선택 박스(크롭) 상태
    let dragging = false; let startX=0, startY=0;
    let rect = {x:0,y:0,w:0,h:0};

    function resetCrop(){
      rect = {x:0,y:0,w:0,h:0};
      cropBox.style.display='none';
      cropBox.style.width='0px';
      cropBox.style.height='0px';
    }

    function getRelXY(e){
      const r = img.getBoundingClientRect();
      const clientX = (e.touches? e.touches[0].clientX : e.clientX);
      const clientY = (e.touches? e.touches[0].clientY : e.clientY);
      let x = clientX - r.left;
      let y = clientY - r.top;
      x = Math.max(0, Math.min(x, img.clientWidth));
      y = Math.max(0, Math.min(y, img.clientHeight));
      return {x,y};
    }

    function updateCropBox(){
      cropBox.style.display='block';
      cropBox.style.left = rect.x + 'px';
      cropBox.style.top = rect.y + 'px';
      cropBox.style.width = rect.w + 'px';
      cropBox.style.height = rect.h + 'px';
    }

    function pointerDown(e){
      if(!imgLoaded) return;
      dragging = true;
      const p = getRelXY(e);
      startX = p.x; startY = p.y;
      rect = {x:startX, y:startY, w:0, h:0};
      updateCropBox();
      e.preventDefault();
    }
    function pointerMove(e){
      if(!dragging) return;
      const p = getRelXY(e);
      const x1 = Math.min(startX, p.x);
      const y1 = Math.min(startY, p.y);
      const x2 = Math.max(startX, p.x);
      const y2 = Math.max(startY, p.y);
      rect = {x:x1, y:y1, w:(x2-x1), h:(y2-y1)};
      updateCropBox();
      e.preventDefault();
    }
    function pointerUp(e){
      dragging = false;
      e.preventDefault();
    }

    // 미리보기 영역에 터치/마우스 등록
    const previewWrap = document.getElementById('preview-wrap');
    previewWrap.addEventListener('mousedown', pointerDown);
    previewWrap.addEventListener('mousemove', pointerMove);
    window.addEventListener('mouseup', pointerUp);
    previewWrap.addEventListener('touchstart', pointerDown, {passive:false});
    previewWrap.addEventListener('touchmove', pointerMove, {passive:false});
    window.addEventListener('touchend', pointerUp, {passive:false});

    // 파일 선택 시: 미리보기 로드 + (원하면) 전체 인식
    fileInput.addEventListener('change', async (e)=>{
      imgFile = e.target.files && e.target.files[0];
      resetCrop();
      if(!imgFile){ imgLoaded=false; img.style.display='none'; return; }
      const objectUrl = URL.createObjectURL(imgFile);
      img.onload = ()=>{
        imgNaturalW = img.naturalWidth;
        imgNaturalH = img.naturalHeight;
        imgLoaded = true;
      };
      img.src = objectUrl;
      img.style.display='block';
      // 자동 전체 인식(원치 않으면 주석 처리)
      runOCR(imgFile);
    });

    // OCR 실행(파일/캔버스 공용)
    async function runOCR(source){
      bar.style.width='0%';
      try{
        const { data } = await Tesseract.recognize(source, 'eng', {
          logger: m => {
            if(m.status==='recognizing text' && m.progress!=null){
              bar.style.width = Math.round(m.progress*100)+'%';
            }
          }
        });
        let t = (data.text || '').trim()
          .replace(/\r/g,'')
          .replace(/[·×]/g,'*')
          .replace(/[＝=]/g,'=')
          .replace(/[−–—]/g,'-')
          .replace(/[^\dxxyy=\+\-\*\/\^\.\,\n]/gi,'');
        t = t.split('\n').map(s=>s.trim()).filter(Boolean).join(', ');
        document.getElementById('ocr-text').value = t || '';
      }catch(err){
        alert('OCR 중 오류가 발생했습니다. 사진을 다시 촬영해 주세요.');
        console.error(err);
      }finally{
        setTimeout(()=> bar.style.width='0%', 700);
      }
    }

    // 선택 영역만 OCR
    function cropToCanvas(){
      if(!imgLoaded || rect.w<10 || rect.h<10){ alert('선택한 영역이 너무 작습니다. 네모를 드래그해 문제 부분만 크게 선택해 주세요.'); return null; }
      // 미리보기→원본 좌표 변환
      const scale = imgNaturalW / img.clientWidth; // 가로 기준(세로도 같은 배율)
      const sx = Math.round(rect.x * scale);
      const sy = Math.round(rect.y * scale);
      const sw = Math.round(rect.w * scale);
      const sh = Math.round(rect.h * scale);

      const cvs = document.createElement('canvas');
      cvs.width = sw; cvs.height = sh;
      const ctx = cvs.getContext('2d');

      // 원본 이미지를 로드해 drawImage
      const original = new Image();
      original.crossOrigin = 'anonymous';
      original.src = img.src;
      return new Promise(resolve=>{
        original.onload = ()=>{
          ctx.drawImage(original, sx, sy, sw, sh, 0, 0, sw, sh);
          resolve(cvs);
        };
        original.onerror = ()=> resolve(null);
      });
    }

    // 버튼: 전체 인식 / 선택 인식 / 선택 초기화
    document.getElementById('btn-ocr-all').addEventListener('click', ()=>{
      if(!imgFile) return alert('먼저 사진을 선택해 주세요.');
      runOCR(imgFile);
    });
    document.getElementById('btn-ocr-crop').addEventListener('click', async ()=>{
      if(!imgLoaded) return alert('먼저 사진을 선택해 주세요.');
      const cvs = await cropToCanvas();
      if(!cvs) return;
      runOCR(cvs);
    });
    document.getElementById('btn-ocr-clear').addEventListener('click', resetCrop);

    // “채우고 풀이로 이동”
    function onFill(choice, sourceId){
      const type = choice==='auto' ? autoDetect(document.getElementById('ocr-text').value) : choice;
      const txt  = sourceId==='ocr' ? document.getElementById('ocr-text').value : document.getElementById('qi-text').value;
      let v=null;
      if(type==='linear'){
        v=parseLinear(txt); if(!v) return alert('1차 예: 2x+3=11');
        fillLinear(v); activateTab('linear');
      }else if(type==='quadratic'){
        v=parseQuadratic(txt); if(!v) return alert('이차 예: x^2-5x+6=0 (=0 형태)');
        fillQuadratic(v); activateTab('quadratic');
      }else{
        v=parseSystem(txt); if(!v) return alert('연립 예: 2x+y=11, x+y=8 (쉼표로 두 식)');
        fillSystem(v); activateTab('system');
      }
      window.scrollTo({top:document.querySelector('#'+type).offsetTop-10, behavior:'smooth'});
    }
    document.getElementById('qi-fill').addEventListener('click', ()=>{
      const sel = document.getElementById('qi-type').value; onFill(sel, 'ocr');
    });
    document.getElementById('qi-fill2').addEventListener('click', ()=>{
      const sel = document.getElementById('qi-type2').value; onFill(sel, 'text');
    });
  })();
  // ===== /텍스트 자동 파서 + OCR + 크롭 =====
</script>

<!-- 서비스워커 등록: body 끝에 두세요 -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/math-coach/service-worker.js').catch(console.error);
    });
  }
</script>
</body>
</html>
