<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>ìˆ˜í•™ ì½”ì¹­ v1.2</title>

  <!-- PWA -->
  <link rel="manifest" href="/math-coach/manifest.json">
  <meta name="theme-color" content="#ffffff">

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬: Tesseract.js(ê³ ì •ë°€ OCR), OpenCV.js(ì„ íƒ) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="cvReady()" onerror="cvError()"></script>

  <style>
    :root {
      --bg:#ffffff; --text:#111827; --muted:#6b7280; --card:#ffffff; --line:#e5e7eb;
      --accent:#2563eb; --ok:#059669; --warn:#d97706; --bad:#dc2626; --shadow:0 8px 24px rgba(17,24,39,.08)
    }
    *{box-sizing:border-box;font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,Segoe UI,sans-serif}
    html,body{height:100%}
    body{
      margin:0;color:var(--text);
      background: linear-gradient(180deg,#f9fbff 0%, #ffffff 30%, #f7f8ff 100%) no-repeat fixed;
    }
    header{padding:14px 16px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:30}
    header .wrap{max-width:980px;margin:0 auto;display:flex;align-items:center;gap:10px}
    header img{width:32px;height:32px;border-radius:10px;object-fit:cover;background:#f3f4f6}
    header h1{margin:0;font-size:18px;font-weight:800}
    header p{margin:0;color:var(--muted);font-size:12px}

    .container{max-width:980px;margin:0 auto;padding:16px 16px 96px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:var(--shadow)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:280px}
    label{display:block;margin:8px 0 6px;color:#374151;font-size:14px;font-weight:700}
    select,button,input[type=file]{padding:12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--text);width:100%}
    button{cursor:pointer}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .muted{color:var(--muted);font-size:12px}
    .hint{background:#f9fafb;border:1px solid var(--line);padding:12px;border-radius:12px;margin:8px 0}
    .ok{color:var(--ok);font-weight:700}
    .warn{color:var(--warn);font-weight:700}
    .bad{color:var(--bad);font-weight:700}
    .progress{height:6px;background:#eef2ff;border-radius:999px;overflow:hidden;margin-top:8px}
    .bar{height:100%;width:0;background:#6366f1;transition:width .2s}
    .title{font-weight:800;margin:0 0 6px}
    .steps ol{margin:8px 0 0 18px}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .tag{display:inline-block;border:1px solid var(--line);background:#f9fafb;border-radius:999px;padding:4px 8px;font-size:12px;color:#374151;margin-right:6px}

    /* ë¯¸ë¦¬ë³´ê¸°+í¬ë¡­ ë°•ìŠ¤(ì´ë™/ë¦¬ì‚¬ì´ì¦ˆ/ì ê¸ˆ) */
    #preview-wrap{position:relative;border:1px dashed var(--line);border-radius:16px;padding:10px;background:#fff;min-height:260px}
    #bg-img{position:absolute;inset:0;opacity:.06;pointer-events:none;object-fit:cover;border-radius:16px}
    #img-preview{max-width:100%;display:none;border-radius:12px;touch-action:none;-webkit-user-drag:none;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;position:relative}
    #crop-box{position:absolute;border:2px solid var(--accent);background:rgba(37,99,235,.06);display:none;touch-action:none}
    #crop-box .handle{position:absolute;width:16px;height:16px;background:#fff;border:2px solid var(--accent);border-radius:50%;box-shadow:0 1px 2px rgba(0,0,0,.12)}
    .h-nw{left:-8px;top:-8px}.h-n{left:calc(50% - 8px);top:-8px}.h-ne{right:-8px;top:-8px}
    .h-e{right:-8px;top:calc(50% - 8px)}.h-se{right:-8px;bottom:-8px}.h-s{left:calc(50% - 8px);bottom:-8px}
    .h-sw{left:-8px;bottom:-8px}.h-w{left:-8px;top:calc(50% - 8px)}
    .guide{position:absolute;left:12px;top:12px;background:#ffffff;color:#111827;padding:8px 10px;border-radius:10px;border:1px solid var(--line);font-size:12px;box-shadow:var(--shadow)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:#fff}

    /* í•˜ë‹¨ ë‚´ë¹„(ì•± ëŠë‚Œ) */
    nav{position:fixed;bottom:0;left:0;right:0;background:#fff;border-top:1px solid var(--line);padding:10px 16px;z-index:40}
    nav .nav-wrap{max-width:980px;margin:0 auto;display:flex;justify-content:space-between;align-items:center}
    nav button{flex:1;margin:0 4px;padding:12px;border-radius:12px;border:1px solid var(--line);background:#fff}
    nav button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <img src="/math-coach/mascot.png" alt="ë§ˆìŠ¤ì½”íŠ¸" onerror="this.style.display='none'">
    <div>
      <h1>ìˆ˜í•™ ì½”ì¹­</h1>
      <p>ì‚¬ì§„ ì˜¬ë¦¬ê¸° â†’ â€œë¬¸ì œë§Œâ€ ë„¤ëª¨ë¡œ ë§ì¶”ê³  â†’ í’€ê¸°. í•´ì„¤ì€ ë¬¸ì œì§‘ì²˜ëŸ¼ ì¹œì ˆí•˜ê²Œ!</p>
    </div>
  </div>
</header>

<div class="container">

  <!-- ì‚¬ì§„ ì…ë ¥ + ì„ íƒ ë°•ìŠ¤ -->
  <section class="card">
    <div class="row">
      <div class="col">
        <label>ì‚¬ì§„ ì„ íƒ/ì´¬ì˜</label>
        <input id="img-file" type="file" accept="image/*" capture="environment">
        <div id="preview-wrap" style="margin-top:10px">
          <img id="bg-img" src="/math-coach/bg.jpg" alt="" onerror="this.style.display='none'">
          <div class="guide" id="guide" style="display:none">ì‚¬ì§„ì—ì„œ ì›í•˜ì‹œëŠ” ë¶€ë¶„ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</div>
          <img id="img-preview" alt="ë¯¸ë¦¬ë³´ê¸°">
          <div id="crop-box">
            <div class="handle h-nw" data-dir="nw"></div>
            <div class="handle h-n"  data-dir="n"></div>
            <div class="handle h-ne" data-dir="ne"></div>
            <div class="handle h-e"  data-dir="e"></div>
            <div class="handle h-se" data-dir="se"></div>
            <div class="handle h-s"  data-dir="s"></div>
            <div class="handle h-sw" data-dir="sw"></div>
            <div class="handle h-w"  data-dir="w"></div>
          </div>
        </div>

        <div class="btns" style="margin-top:10px">
          <button id="btn-reset">ì˜ì—­ ì´ˆê¸°í™”</button>
          <button id="btn-lock" class="pill">ğŸ”’ ì˜ì—­ ì ê·¸ê¸°</button>
          <button id="btn-boost" class="pill">âœ¨ ì‚¬ì§„ ì„ ëª…ë„ ì˜¬ë¦¬ê¸°</button>
          <button id="btn-solve" class="primary">í’€ê¸°</button>
        </div>

        <div class="progress"><div class="bar" id="ocr-bar"></div></div>
        <p class="muted">íŒ: ë¬¸ì œë§Œ ë„¤ëª¨ ì•ˆì— ë‹´ì•„ ì£¼ì„¸ìš”. ë°ê³  ì„ ëª…í•œ ì‚¬ì§„ì¼ìˆ˜ë¡ ì •í™•í•´ìš”.</p>
      </div>

      <div class="col">
        <label>ì§„í–‰ ìƒíƒœ</label>
        <div class="hint">
          <span class="tag" id="tag-cv">ì‚¬ì§„ ë³´ì •: ì¤€ë¹„</span>
          <span class="tag" id="tag-ocr">ì½ê¸°: ëŒ€ê¸°</span>
          <span class="tag" id="tag-type">ìœ í˜•: -</span>
          <span class="tag" id="tag-lock">ì ê¸ˆ: í•´ì œ</span>
        </div>

        <label style="margin-top:8px">ì½ì€ ë‚´ìš©(í™•ì¸ìš©)</label>
        <div id="recognized" class="hint" style="min-height:68px;white-space:pre-wrap"></div>
      </div>
    </div>
  </section>

  <!-- ê²°ê³¼(ì¹œì ˆ í•´ì„¤) -->
  <section class="card" id="result" style="display:none">
    <div class="title">í’€ì´ ê²°ê³¼</div>
    <div id="summary" class="hint"></div>
    <div class="divider"></div>
    <div class="title">ì¹œì ˆí•œ í•´ì„¤(ë‹¨ê³„ë³„)</div>
    <ol id="steps-ol"></ol>
    <div class="divider"></div>
    <div class="title">ê²€ì‚°</div>
    <div id="verify" class="hint">-</div>
  </section>

  <!-- ë„í˜•(ë² íƒ€) -->
  <section class="card" id="geom" style="display:none">
    <div class="title">ë„í˜• ê°ì§€(ë² íƒ€)</div>
    <div id="geom-summary" class="hint"></div>
    <div class="divider"></div>
    <div class="title">í’€ì´ ì „ëµ(ì„¤ëª…í˜•)</div>
    <div id="geom-hint" class="hint"></div>
  </section>

  <!-- ì•ˆë‚´ -->
  <section class="card">
    <div class="title">ì•ˆë‚´</div>
    <ul class="muted" style="margin:6px 0 0 18px">
      <li>í•™ìŠµ ë³´ì¡°ìš©ì…ë‹ˆë‹¤. ì •ë‹µë§Œ ë³´ê¸°ë³´ë‹¤ â€œì´ìœ /ê³¼ì •/ê²€ì‚°â€ì„ í•¨ê»˜ ë³´ì„¸ìš”.</li>
      <li>í•„ê¸° ì‚¬ì§„ì€ ì •í™•ë„ê°€ ë–¨ì–´ì§ˆ ìˆ˜ ìˆì–´ìš”. â€œì‚¬ì§„ ì„ ëª…ë„ ì˜¬ë¦¬ê¸°â€ í›„ ë°•ìŠ¤ë¥¼ í¬ê²Œ ì¡ì•„ ì£¼ì„¸ìš”.</li>
      <li>ê°œì¸ì •ë³´ë¥¼ ìˆ˜ì§‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. <a href="/math-coach/privacy.html" style="color:#2563eb">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a></li>
    </ul>
  </section>
</div>

<nav>
  <div class="nav-wrap">
    <button id="nav-home">í™ˆ</button>
    <button id="nav-album">ì•¨ë²”ì—ì„œ ì„ íƒ</button>
    <button id="nav-solve" class="primary">í’€ê¸°</button>
  </div>
</nav>

<script>
  // ìƒíƒœ íƒœê·¸
  function cvReady(){ document.getElementById('tag-cv').textContent='ì‚¬ì§„ ë³´ì •: ì¤€ë¹„'; }
  function cvError(){ document.getElementById('tag-cv').textContent='ì‚¬ì§„ ë³´ì •: ì‹¤íŒ¨'; }

  // ìš”ì†Œ
  const fileInput = document.getElementById('img-file');
  const img = document.getElementById('img-preview');
  const crop = document.getElementById('crop-box');
  const wrap = document.getElementById('preview-wrap');
  const guide= document.getElementById('guide');
  const recognized = document.getElementById('recognized');
  const bar = document.getElementById('ocr-bar');

  const btnReset= document.getElementById('btn-reset');
  const btnLock = document.getElementById('btn-lock');
  const btnSolve= document.getElementById('btn-solve');
  const btnBoost= document.getElementById('btn-boost');

  const navHome = document.getElementById('nav-home');
  const navAlbum= document.getElementById('nav-album');
  const navSolve= document.getElementById('nav-solve');

  // í¬ë¡­/ì ê¸ˆ ìƒíƒœ
  let imgLoaded=false, imgW=0, imgH=0;
  let rect = {x:0,y:0,w:0,h:0};
  let drag = {mode:'none', dir:null, offsetX:0, offsetY:0};
  let LOCKED=false;
  let BOOST=false;

  const clamp=(v,min,max)=> Math.max(min, Math.min(max, v));
  function showRect(r){ crop.style.display='block'; crop.style.left=r.x+'px'; crop.style.top=r.y+'px'; crop.style.width=r.w+'px'; crop.style.height=r.h+'px'; }
  function initDefaultRect(){
    const W = img.clientWidth, H = img.clientHeight;
    const w = Math.round(W*0.84), h = Math.round(H*0.4);
    rect = {x:Math.round((W-w)/2), y:Math.round((H-h)/2), w, h};
    showRect(rect);
  }
  function getRelXY(e){
    const r = img.getBoundingClientRect();
    return { x: clamp(e.clientX - r.left, 0, img.clientWidth),
             y: clamp(e.clientY - r.top , 0, img.clientHeight) };
  }
  function hitHandle(px,py){
    const hs = crop.querySelectorAll('.handle');
    for(const h of hs){
      const bb = h.getBoundingClientRect();
      if(px>=bb.left && px<=bb.right && py>=bb.top && py<=bb.bottom) return h.dataset.dir;
    }
    return null;
  }

  // ì ê¸ˆ í† ê¸€
  btnLock.onclick = ()=>{
    LOCKED = !LOCKED;
    document.getElementById('tag-lock').textContent = 'ì ê¸ˆ: ' + (LOCKED?'ON':'í•´ì œ');
    btnLock.innerHTML = LOCKED ? 'ğŸ”“ ì˜ì—­ í’€ê¸°' : 'ğŸ”’ ì˜ì—­ ì ê·¸ê¸°';
  };

  // í¬ì¸í„°(ì´ë™/ë¦¬ì‚¬ì´ì¦ˆ)
  wrap.addEventListener('pointerdown', (e)=>{
    if(!imgLoaded || LOCKED) return;
    const dir = hitHandle(e.clientX,e.clientY);
    if(dir){ drag.mode='resize'; drag.dir=dir; }
    else{
      const cb = crop.getBoundingClientRect();
      const inside = e.clientX>=cb.left && e.clientX<=cb.right && e.clientY>=cb.top && e.clientY<=cb.bottom;
      if(inside){ drag.mode='move'; drag.offsetX = e.clientX - cb.left; drag.offsetY = e.clientY - cb.top; }
      else{ drag.mode='new'; const p=getRelXY(e); rect={x:p.x,y:p.y,w:1,h:1}; showRect(rect); }
    }
    wrap.setPointerCapture?.(e.pointerId); e.preventDefault();
  });
  wrap.addEventListener('pointermove', (e)=>{
    if(!imgLoaded || drag.mode==='none' || LOCKED) return;
    const p = getRelXY(e), W = img.clientWidth, H = img.clientHeight;
    if(drag.mode==='move'){
      rect.x = clamp(p.x - drag.offsetX, 0, W-rect.w);
      rect.y = clamp(p.y - drag.offsetY, 0, H-rect.h);
      showRect(rect);
    }else if(drag.mode==='new'){
      rect.w = clamp(p.x - rect.x, 1, W-rect.x);
      rect.h = clamp(p.y - rect.y, 1, H-rect.y);
      showRect(rect);
    }else if(drag.mode==='resize'){
      let x=rect.x, y=rect.y, w=rect.w, h=rect.h;
      const d = drag.dir;
      if(d.includes('n')){ h += (y - p.y); y = p.y; }
      if(d.includes('s')){ h = p.y - y; }
      if(d.includes('w')){ w += (x - p.x); x = p.x; }
      if(d.includes('e')){ w = p.x - x; }
      if(w<24){ if(d.includes('w')) x = x+(w-24); w=24; }
      if(h<24){ if(d.includes('n')) y = y+(h-24); h=24; }
      x = clamp(x, 0, W-24); y = clamp(y, 0, H-24);
      w = clamp(w, 24, W-x); h = clamp(h, 24, H-y);
      rect = {x,y,w,h}; showRect(rect);
    }
    e.preventDefault();
  });
  window.addEventListener('pointerup', (e)=>{ drag.mode='none'; drag.dir=null; try{wrap.releasePointerCapture?.(e.pointerId);}catch(_){}});

  // íŒŒì¼ ì„ íƒ â†’ ë¯¸ë¦¬ë³´ê¸°/ê¸°ë³¸ ë°•ìŠ¤/ê°€ì´ë“œ
  fileInput.addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    resetOutputs();
    if(!f){ imgLoaded=false; img.style.display='none'; crop.style.display='none'; guide.style.display='none'; return; }
    const url = URL.createObjectURL(f);
    img.onload = ()=>{
      imgW=img.naturalWidth; imgH=img.naturalHeight; imgLoaded=true;
      img.style.display='block';
      guide.style.display='block';
      setTimeout(()=>{ guide.style.display='none'; if(!LOCKED) initDefaultRect(); }, 900);
    };
    img.src = url;
  });

  function resetOutputs(){
    document.getElementById('result').style.display='none';
    document.getElementById('geom').style.display='none';
    recognized.textContent=''; document.getElementById('tag-type').textContent='ìœ í˜•: -';
    document.getElementById('tag-ocr').textContent='ì½ê¸°: ëŒ€ê¸°';
  }

  // í•˜ë‹¨ ë‚´ë¹„
  navHome.onclick  = ()=> window.scrollTo({top:0,behavior:'smooth'});
  navAlbum.onclick = ()=> fileInput.click();
  navSolve.onclick = ()=> btnSolve.click();

  btnReset.onclick = ()=>{ if(imgLoaded){ initDefaultRect(); LOCKED=false; document.getElementById('tag-lock').textContent='ì ê¸ˆ: í•´ì œ'; btnLock.innerHTML='ğŸ”’ ì˜ì—­ ì ê·¸ê¸°'; } };
  btnBoost.onclick = ()=>{ BOOST=!BOOST; btnBoost.innerHTML = BOOST? 'ğŸ”„ ê¸°ë³¸ ì„ ëª…ë„ë¡œ' : 'âœ¨ ì‚¬ì§„ ì„ ëª…ë„ ì˜¬ë¦¬ê¸°'; };

  // ê¸€ì í¬ê²Œ ë§Œë“œëŠ” í¬ë¡­(ìŠ¤ì¼€ì¼ ì—…)
  function cropToCanvas(){
    if(!imgLoaded || rect.w<24 || rect.h<24){
      alert('ë¬¸ì œë§Œ ë³´ì´ë„ë¡ ë„¤ëª¨ë¥¼ ë” í¬ê²Œ ë§ì¶° ì£¼ì„¸ìš”.');
      return null;
    }
    const sx = (img.naturalWidth||imgW)/img.clientWidth;
    const sy = (img.naturalHeight||imgH)/img.clientHeight;
    const x = Math.round(rect.x*sx), y = Math.round(rect.y*sy);
    const w = Math.round(rect.w*sx), h = Math.round(rect.h*sy);
    const scale = BOOST ? 2.6 : 2.2; // ì¸ì‹ë¥ â†‘
    const c = document.createElement('canvas');
    c.width = Math.round(w*scale);
    c.height = Math.round(h*scale);
    const ctx = c.getContext('2d');
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(img, x,y,w,h, 0,0,c.width,c.height);
    return c;
  }

  // ìˆ˜ì‹ ì „ìš© OCR(PSM7 â†’ 6, ê³ ì •ë°€ ëª¨ë¸ + í›„ì²˜ë¦¬)
  async function ocrMathStrong(canvas) {
    const langPath = 'https://raw.githubusercontent.com/tesseract-ocr/tessdata_best/4.1.0';
    const tryOnce = async (psm) => {
      const { data } = await Tesseract.recognize(canvas, 'eng+kor', {
        langPath,
        oem: 1,                     // LSTM ì „ìš©(ì •í™•ë„â†‘)
        tessedit_pageseg_mode: psm, // 7: í•œ ì¤„ ìˆ˜ì‹, 6: ë¬¸ë‹¨
        tessedit_char_whitelist: '0123456789xXyY()+-*/=<>&^.,â‰¤â‰¥<>',
        tessedit_char_blacklist: '{}[]\\|`~;:"\''
      });
      return postClean(data.text || '', data.confidence || 0);
    };
    const a = await tryOnce(7);
    if (isGood(a)) return a.clean;
    const b = await tryOnce(6);
    return (a.score >= b.score ? a.clean : b.clean);
  }
  function postClean(s, conf) {
    let t = (s || '')
      .replace(/\r/g, '')
      .replace(/[Â·Ã—]/g, '*')
      .replace(/[ï¼=]/g, '=')
      .replace(/[âˆ’â€“â€”]/g, '-')
      .replace(/ï¼¯/g, '0')
      .replace(/(?<=\d)[lI](?=\d)/g, '1'); // ìˆ«ì ì‚¬ì´ l/I â†’ 1
    const mathOnly = t.replace(/[^0-9a-zA-Zê°€-í£\s\(\)\+\-\*\/=<>&\^\,\.\u2264\u2265<>]/g, '');
    const bonus = (/x\^?2|=|[<>]|y\s*=|x\s*=|[,;].*x.*y/.test(mathOnly) ? 12 : 0);
    return { clean: mathOnly.trim() || t.trim(), score: (conf || 0) + bonus };
  }
  function isGood(res) {
    if (!res) return false;
    return /[=xy<>]/i.test(res.clean || '') && (res.clean || '').length >= 5;
  }

  // â”€â”€ í’€ì´ ì—”ì§„(ê°„ë‹¨í˜•: 1ì°¨/ì´ì°¨/ì—°ë¦½/ë¶€ë“±ì‹/í•¨ìˆ˜ êµì ) â”€â”€
  const resBox=document.getElementById('result'), stepsOl=document.getElementById('steps-ol'), summary=document.getElementById('summary'), verify=document.getElementById('verify');
  function clean(s){ return s.toLowerCase().replace(/\s+/g,' ').replace(/â‰¥/g,'>=').replace(/â‰¤/g,'<=').replace(/ï¼œ/g,'<').replace(/ï¼/g,'>').replace(/[â… l]/g,'1').replace(/ï¼¯/g,'0').trim(); }
  function detectType(t){
    const s=clean(t);
    if(/(ì‚¼ê°í˜•|ì‚¬ê°í˜•|ì›|ì§ì„ |ê°|âˆ |í‰í–‰|ë‹®ìŒ|í”¼íƒ€ê³ ë¼ìŠ¤|ì¤‘ì |ë‚´ì‹¬|ì™¸ì‹¬)/.test(s)) return 'geometry';
    if(/y\s*=/.test(s) && (s.match(/y\s*=/g)||[]).length>=2) return 'func';
    if(/[,;].*x.*y/.test(s) || /x\s*\+\s*y\s*=/.test(s)) return 'system';
    if(/(>=|<=|>|<)/.test(s) && /x/.test(s)) return 'ineq';
    if(/x\^?2|xÂ²/.test(s) && /=\s*0/.test(s)) return 'quadratic';
    if(/=\s*/.test(s) && /x/.test(s)) return 'linear';
    return 'unknown';
  }
  const gcd=(a,b)=>{a=Math.abs(a);b=Math.abs(b);while(b){[a,b]=[b,a%b]}return a||1};
  const frac=(n,d)=>{ if(d===0) return 'ì •ì˜X'; if(n===0) return '0'; const g=gcd(n,d); n/=g; d/=g; if(d<0){d*=-1;n*=-1} return d===1?`${n}`:`${n}/${d}`; };

  function renderResult(summaryText, stepsArr, verifyText){
    resBox.style.display='block';
    summary.textContent=summaryText;
    stepsOl.innerHTML='';
    stepsArr.forEach(s=>{ const li=document.createElement('li'); li.textContent=s; stepsOl.appendChild(li); });
    verify.innerHTML = verifyText.includes('í†µê³¼')?`<span class="ok">${verifyText}</span>`: (verifyText==='-'?'-':`<span class="warn">${verifyText}</span>`);
    window.scrollTo({top:resBox.offsetTop-10,behavior:'smooth'});
  }

  function solveFromText(raw){
    const t = clean(raw); const typ=detectType(t);
    document.getElementById('tag-type').textContent='ìœ í˜•: '+({linear:'1ì°¨',quadratic:'ì´ì°¨',system:'ì—°ë¦½',ineq:'ë¶€ë“±ì‹',func:'í•¨ìˆ˜ êµì ',geometry:'ë„í˜•',unknown:'ì•Œìˆ˜ì—†ìŒ'}[typ]||typ);
    document.getElementById('result').style.display='none';
    document.getElementById('geom').style.display='none';

    if(typ==='geometry'){ renderGeometry(t); return; }

    if(typ==='linear'){
      const m=t.match(/([+\-]?\d*\.?\d*)x(?:\s*([+\-]\s*\d+\.?\d*))?\s*=\s*([+\-]?\d+\.?\d*)/i);
      if(!m){ alert('1ì°¨ ë°©ì •ì‹ì„ ì°¾ì§€ ëª»í–ˆì–´ìš”. ë°•ìŠ¤ë¥¼ ë” íƒ€ì´íŠ¸í•˜ê²Œ ë§ì¶° ì£¼ì„¸ìš”.'); return; }
      const A=(m[1]===''||m[1]==='+')?1:(m[1]==='-'?-1:parseFloat(m[1])), B=m[2]?parseFloat(m[2].replace(/\s+/g,'')):0, C=parseFloat(m[3]);
      const num=C-B, den=A, x=num/den;
      renderResult(`ì •ë‹µ: x = ${frac(num,den)}${Number.isFinite(x)&&!Number.isInteger(x)?` (â‰ˆ ${x.toFixed(6)})`:''}`,
        [`ìƒìˆ˜í•­ì„ ë°˜ëŒ€ë¡œ ì˜®ê¹ë‹ˆë‹¤. (${A}x = ${C} ${B>=0?'-':'+'} ${Math.abs(B)})`,`xì˜ ê³„ìˆ˜(${A})ë¡œ ë‚˜ëˆ•ë‹ˆë‹¤.`,`ë”°ë¼ì„œ x = (${C} - ${B}) / ${A} = ${frac(num,den)}`],
        Math.abs(A*x+B-C)<1e-9?'ê²€ì‚° í†µê³¼':'ê²€ì‚° ì‹¤íŒ¨'); return;
    }

    if(typ==='quadratic'){
      const s2=t.replace(/xÂ²/g,'x^2').replace(/\s+/g,''), q=s2.match(/^([+\-]?\d*\.?\d*)x\^2([+\-]\d*\.?\d*)x([+\-]\d+\.?\d*)=0$/);
      if(!q){ alert('ì´ì°¨ ë°©ì •ì‹ì€ =0 í˜•íƒœê°€ ì¸ì‹ì´ ì˜ ë©ë‹ˆë‹¤.'); return; }
      const A=(q[1]===''||q[1]==='+')?1:(q[1]==='-'?-1:parseFloat(q[1])), B=(q[2]===''||q[2]==='+')?1:(q[2]==='-'?-1:parseFloat(q[2])), C=parseFloat(q[3]);
      const D=B*B-4*A*C;
      if(D>=0){ const sD=Math.sqrt(D), x1=(-B+sD)/(2*A), x2=(-B-sD)/(2*A), f=x=>A*x*x+B*x+C;
        renderResult(`ì •ë‹µ: x â‰ˆ ${x1.toFixed(6)}, ${x2.toFixed(6)}`,
          [`í‘œì¤€í˜• ${A}xÂ² ${B>=0?'+':''}${B}x ${C>=0?'+':''}${C} = 0, D=bÂ²-4ac=${D}`,`D>0 â†’ ì„œë¡œ ë‹¤ë¥¸ ë‘ ì‹¤ê·¼`,`ê·¼ì˜ ê³µì‹ x = (-b Â± âˆšD)/(2a)`,`ê°’ì„ ë„£ìœ¼ë©´ x â‰ˆ ${x1.toFixed(6)}, ${x2.toFixed(6)}`],
          (Math.abs(f(x1))<1e-6&&Math.abs(f(x2))<1e-6)?'ê²€ì‚° í†µê³¼':'ê²€ì‚° í™•ì¸ í•„ìš”');
      }else{
        renderResult('ì •ë‹µ(ë³µì†Œìˆ˜): x = (âˆ’b Â± iâˆš|D|)/(2a)',
          [`í‘œì¤€í˜• ${A}xÂ² ${B>=0?'+':''}${B}x ${C>=0?'+':''}${C} = 0, D=bÂ²-4ac=${D}`,`D<0 â†’ ì‹¤ìˆ˜í•´ ì—†ìŒ`,`ë³µì†Œìˆ˜ ë²”ìœ„ì—ì„œ í•´ë¥¼ í‘œí˜„í•©ë‹ˆë‹¤.`],
          'ì‹¤ìˆ˜ ë²”ìœ„ ê²€ì‚° í•´ë‹¹ ì—†ìŒ');
      }
      return;
    }

    if(typ==='system'){
      const parts=t.split(/[,;](?![^()]*\))/).map(v=>v.trim());
      const re=/([+\-]?\d*\.?\d*)x\s*([+\-]\s*\d*\.?\d*)y\s*=\s*([+\-]?\d+\.?\d*)/;
      if(parts.length<2){ alert('ì—°ë¦½ ë‘ ì‹ì„ ì‰¼í‘œë¡œ êµ¬ë¶„í•˜ë©´ ì¸ì‹ì´ ì˜ ë©ë‹ˆë‹¤.'); return; }
      const m1=parts[0].match(re), m2=parts[1].match(re); if(!m1||!m2){ alert('ì—°ë¦½ í•´ì„ì´ ì–´ë ¤ì›Œìš”. ë°•ìŠ¤ë¥¼ ë” ì •í™•íˆ ë§ì¶° ì£¼ì„¸ìš”.'); return; }
      const n=v=>(v===''||v==='+')?1:(v==='-'?-1:parseFloat(v));
      const a1=n(m1[1]), b1=n((m1[2]||'').replace(/\s+/g,'')), c1=parseFloat(m1[3]);
      const a2=n(m2[1]), b2=n((m2[2]||'').replace(/\s+/g,'')), c2=parseFloat(m2[3]);
      const D=a1*b2-b1*a2; if(D===0){ renderResult('ìœ ì¼í•´ ì—†ìŒ(íŠ¹ìˆ˜ ì¼€ì´ìŠ¤)',['Î”=0 â†’ ìœ ì¼í•´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'],'-'); return; }
      const Dx=c1*b2-b1*c2, Dy=a1*c2-c1*a2; const x=Dx/D, y=Dy/D;
      renderResult(`ì •ë‹µ: (x, y) = (${x.toFixed(6)}, ${y.toFixed(6)})`,
        [`ë‘ ì‹: ${a1}x ${b1>=0?'+':''}${b1}y = ${c1}, ${a2}x ${b2>=0?'+':''}${b2}y = ${c2}`,`Cramerì˜ ê³µì‹ Î” = aâ‚bâ‚‚ âˆ’ bâ‚aâ‚‚`,`Î”â‰ 0ì´ë©´ x=Î”x/Î”, y=Î”y/Î”`,`ê³„ì‚°í•˜ë©´ x=${x.toFixed(6)}, y=${y.toFixed(6)}`],
        (Math.abs(a1*x+b1*y-c1)<1e-9 && Math.abs(a2*x+b2*y-c2)<1e-9)?'ê²€ì‚° í†µê³¼':'ê²€ì‚° ì‹¤íŒ¨'); return;
    }

    if(typ==='ineq'){
      const m=t.replace(/\s+/g,'').match(/^([+\-]?\d*\.?\d*)x(?:([+\-]\d+\.?\d*))?(>=|<=|>|<)([+\-]?\d+\.?\d*)$/);
      if(!m){ alert('ë¶€ë“±ì‹ ê¸°í˜¸(>,<,â‰¥,â‰¤)ê°€ ë˜ë ·í•˜ê²Œ ë³´ì´ê²Œ ì°ì–´ ì£¼ì„¸ìš”.'); return; }
      const A=(m[1]===''||m[1]==='+')?1:(m[1]==='-'?-1:parseFloat(m[1])), B=m[2]?parseFloat(m[2]):0, op=m[3], C=parseFloat(m[4]);
      const flip=A<0, op2= flip?({'>':'<','<':'>','>=':'<=','<=':'>='}[op]):op, ans=`x ${op2} ${frac(C-B,A)}`;
      renderResult(`ì •ë‹µ: ${ans}`,
        [`${A}x ${B>=0?'+':''}${B} ${op} ${C}`,`ìƒìˆ˜í•­ì„ ì •ë¦¬í•©ë‹ˆë‹¤.`,`ì–‘ë³€ì„ ${A}ë¡œ ë‚˜ëˆŒ ë•Œ ${A<0?'ë¶€ë“±í˜¸ ë°©í–¥ì´ ë°”ë€ë‹ˆë‹¤.':'ë¶€ë“±í˜¸ ë°©í–¥ì€ ìœ ì§€ë©ë‹ˆë‹¤.'}`,`ë”°ë¼ì„œ ${ans}`],
        '-'); return;
    }

    if(typ==='func'){
      const eqs=t.toLowerCase().split(/[,;](?![^()]*\))/).map(v=>v.trim());
      const re=/y\s*=\s*([+\-]?\d*\.?\d*)x\s*([+\-]\s*\d+\.?\d*)?/;
      if(eqs.length<2){ alert('í•¨ìˆ˜ êµì ì€ y=â€¦ í˜•íƒœ ë‘ ê°œë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„í•´ ì£¼ì„¸ìš”.'); return; }
      const m1=eqs[0].match(re), m2=eqs[1].match(re); if(!m1||!m2){ alert('í•¨ìˆ˜ ì‹ì„ ë” ë˜ë ·í•˜ê²Œ ì°ì–´ ì£¼ì„¸ìš”.'); return; }
      const Cc=m=>({k:(m[1]===''||m[1]==='+')?1:(m[1]==='-'?-1:parseFloat(m[1])), n:m[2]?parseFloat(m[2].replace(/\s+/g,'')):0});
      const f1=Cc(m1), f2=Cc(m2); if(f1.k===f2.k){ renderResult(f1.n===f2.n?'ë¬´ìˆ˜íˆ ë§ì€ í•´(ê°™ì€ ì§ì„ )':'í•´ ì—†ìŒ(í‰í–‰)',['ê¸°ìš¸ê¸°ê°€ ê°™ìœ¼ë©´ í‰í–‰/ë™ì¼ ì§ì„ ì…ë‹ˆë‹¤.'],'-'); return; }
      const x=(f2.n-f1.n)/(f1.k-f2.k), y=f1.k*x+f1.n;
      renderResult(`êµì : (x, y) = (${x.toFixed(6)}, ${y.toFixed(6)})`,
        [`ë‘ í•¨ìˆ˜ y=${f1.k}x ${f1.n>=0?'+':''}${f1.n}, y=${f2.k}x ${f2.n>=0?'+':''}${f2.n}`,`ë‘ yë¥¼ ê°™ê²Œ ë‘ê³  ì •ë¦¬: ${(f1.k-f2.k)}x = ${f2.n-f1.n}`,`x = ${x.toFixed(6)}, y = ${y.toFixed(6)}`],
        'ê²€ì‚° í†µê³¼'); return;
    }

    alert('ë¬¸ì œ ìœ í˜•ì„ ìë™ìœ¼ë¡œ íŒë‹¨í•˜ê¸° ì–´ë ¤ì›Œìš”. ì‚¬ì§„ì„ ë” ì„ ëª…í•˜ê²Œ, ë°•ìŠ¤ë¥¼ ë” ì •í™•íˆ ë§ì¶˜ ë’¤ ì¬ì‹œë„í•´ ì£¼ì„¸ìš”.');
  }

  // â€œí’€ê¸°â€ ë²„íŠ¼: í¬ë¡­ â†’ OCR(ê°•í™”) â†’ í’€ì´
  btnSolve.onclick = async ()=>{
    if(!imgLoaded){ alert('ë¨¼ì € ì‚¬ì§„ì„ ì˜¬ë ¤ ì£¼ì„¸ìš”.'); return; }
    document.getElementById('tag-ocr').textContent='ì½ê¸°: ì§„í–‰ì¤‘';
    bar.style.width='0%';
    const cnv = cropToCanvas(); if(!cnv) return;
    const text = await ocrMathStrong(cnv);
    recognized.textContent = text;
    document.getElementById('tag-ocr').textContent='ì½ê¸°: ì™„ë£Œ';
    bar.style.width='0%';
    if(!text){ alert('ì½ì€ ë‚´ìš©ì´ ì—†ì–´ìš”. ë°•ìŠ¤ë¥¼ ë” íƒ€ì´íŠ¸í•˜ê²Œ ë§ì¶”ê³ , ë” ë°ê²Œ ì°ì–´ ì£¼ì„¸ìš”.'); return; }
    solveFromText(text);
  };
</script>

<!-- ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡ -->
<script>
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=> navigator.serviceWorker.register('/math-coach/service-worker.js').catch(console.error));
  }
</script>
</body>
</html>
