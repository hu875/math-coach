<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>ìˆ˜í•™ ì½”ì¹­ v1.8 (Auto-Rotate + Superscript Strong + Hotfix)</title>

  <!-- PWA -->
  <link rel="manifest" href="/math-coach/manifest.json">
  <meta name="theme-color" content="#ffffff">

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

  <style>
    :root { --bg:#ffffff; --text:#111827; --muted:#6b7280; --card:#ffffff; --line:#e5e7eb; --accent:#2563eb; --ok:#059669; --warn:#d97706; --bad:#dc2626; --shadow:0 8px 24px rgba(17,24,39,.08) }
    *{box-sizing:border-box;font-family:system-ui,Apple SD Gothic Neo,Malgun Gothic,Segoe UI,sans-serif}
    html,body{height:100%}
    body{margin:0;color:var(--text);background:linear-gradient(180deg,#f9fbff 0%, #ffffff 30%, #f7f8ff 100%) fixed}
    header{padding:14px 16px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:30}
    header .wrap{max-width:980px;margin:0 auto;display:flex;align-items:center;gap:10px}
    header img{width:32px;height:32px;border-radius:10px;object-fit:cover;background:#f3f4f6}
    header h1{margin:0;font-size:18px;font-weight:800}
    header p{margin:0;color:var(--muted);font-size:12px}
    .container{max-width:980px;margin:0 auto;padding:16px 16px 96px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:14px;box-shadow:var(--shadow)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:280px}
    label{display:block;margin:8px 0 6px;color:#374151;font-size:14px;font-weight:700}
    button,input[type=file]{padding:12px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--text)}
    button{cursor:pointer}
    .btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .muted{color:var(--muted);font-size:12px}
    .hint{background:#f9fafb;border:1px solid var(--line);padding:12px;border-radius:12px;margin:8px 0;white-space:pre-wrap}
    .ok{color:var(--ok);font-weight:700}
    .warn{color:var(--warn);font-weight:700}
    .bad{color:var(--bad);font-weight:700}
    .progress{height:6px;background:#eef2ff;border-radius:999px;overflow:hidden;margin-top:8px}
    .bar{height:100%;width:0;background:#6366f1;transition:width .2s}
    .title{font-weight:800;margin:0 0 6px}
    .steps ol{margin:8px 0 0 18px}
    .divider{height:1px;background:var(--line);margin:12px 0}
    .tag{display:inline-block;border:1px solid var(--line);background:#f9fafb;border-radius:999px;padding:4px 8px;font-size:12px;color:#374151;margin-right:6px}

    #preview-wrap{position:relative;border:1px dashed var(--line);border-radius:16px;padding:10px;background:#fff;min-height:260px}
    #img-preview{max-width:100%;display:none;border-radius:12px;touch-action:none;-webkit-user-drag:none;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none;position:relative}
    #crop-box{position:absolute;border:2px solid var(--accent);background:rgba(37,99,235,.06);display:none;touch-action:none}
    #crop-box .handle{position:absolute;width:16px;height:16px;background:#fff;border:2px solid var(--accent);border-radius:50%;box-shadow:0 1px 2px rgba(0,0,0,.12)}
    .h-nw{left:-8px;top:-8px}.h-n{left:calc(50% - 8px);top:-8px}.h-ne{right:-8px;top:-8px}
    .h-e{right:-8px;top:calc(50% - 8px)}.h-se{right:-8px;bottom:-8px}.h-s{left:calc(50% - 8px);bottom:-8px}
    .h-sw{left:-8px;bottom:-8px}.h-w{left:-8px;top:calc(50% - 8px)}

    nav.card{position:fixed;left:0;right:0;bottom:0;border-top:1px solid var(--line);background:#fff}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <img src="/math-coach/mascot.png" alt="ë§ˆìŠ¤ì½”íŠ¸" onerror="this.style.display='none'">
    <div>
      <h1>ìˆ˜í•™ ì½”ì¹­</h1>
      <p>ì‚¬ì§„ ì˜¬ë¦¬ê¸° â†’ â€œë¬¸ì œë§Œâ€ ë„¤ëª¨ë¡œ ë§ì¶”ê³  â†’ ìë™ íšŒì „ â†’ ë¹ ë¥´ê²Œ í’€ì´</p>
    </div>
  </div>
</header>

<div class="container">
  <section class="card">
    <div class="row">
      <div class="col">
        <label>ì‚¬ì§„ ì„ íƒ/ì´¬ì˜</label>
        <input id="img-file" type="file" accept="image/*" capture="environment">
        <div id="preview-wrap" style="margin-top:10px">
          <img id="img-preview" alt="ë¯¸ë¦¬ë³´ê¸°">
          <div id="crop-box">
            <div class="handle h-nw" data-dir="nw"></div><div class="handle h-n" data-dir="n"></div><div class="handle h-ne" data-dir="ne"></div>
            <div class="handle h-e" data-dir="e"></div><div class="handle h-se" data-dir="se"></div><div class="handle h-s" data-dir="s"></div>
            <div class="handle h-sw" data-dir="sw"></div><div class="handle h-w" data-dir="w"></div>
          </div>
        </div>

        <div class="btns" style="margin-top:10px">
          <button id="btn-lock">ğŸ”’ ì ê¸ˆ</button>
          <button id="btn-solve" class="primary">ë¹ ë¥´ê²Œ í’€ê¸°</button>
        </div>

        <div class="progress"><div class="bar" id="ocr-bar"></div></div>
        <p class="muted">íŒ: ì‹(ìˆ«ì/ê¸°í˜¸)ë§Œ ë„¤ëª¨ì— ë‹´ì•„ ì£¼ì„¸ìš”(ë²ˆí˜¸Â·ë¬¸ì¥ ì œì™¸). ê°€ë¡œë¡œ ë³´ì´ê²Œ, ë°ê³  ì„ ëª…í•˜ê²Œ.</p>
      </div>

      <div class="col">
        <label>ì§„í–‰ ìƒíƒœ</label>
        <div class="hint">
          <span class="tag" id="tag-ocr">ì½ê¸°: ëŒ€ê¸°</span>
          <span class="tag" id="tag-type">ìœ í˜•: -</span>
          <span class="tag" id="tag-lock">ì ê¸ˆ: í•´ì œ</span>
        </div>

        <label style="margin-top:8px">ì½ì€ ë‚´ìš©</label>
        <div id="recognized" class="hint">(ëŒ€ê¸°)</div>
      </div>
    </div>
  </section>

  <section class="card" id="result" style="display:none">
    <div class="title">í’€ì´ ê²°ê³¼</div>
    <div id="summary" class="hint"></div>
    <div class="divider"></div>
    <div class="title">ì¹œì ˆí•œ í•´ì„¤(ë‹¨ê³„ë³„)</div>
    <ol id="steps-ol"></ol>
    <div class="divider"></div>
    <div class="title">ê²€ì‚°</div>
    <div id="verify" class="hint">-</div>
  </section>
</div>

<nav class="card">
  <div class="row" style="margin:0">
    <div class="col" style="min-width:auto"><button id="nav-home">í™ˆ</button></div>
    <div class="col" style="min-width:auto"><button id="nav-album">ì•¨ë²”</button></div>
    <div class="col" style="min-width:auto"><button id="nav-solve" class="primary">í’€ê¸°</button></div>
  </div>
</nav>

<script>
  // ìš”ì†Œ/ìƒíƒœ
  const imgEl = document.getElementById('img-preview');
  const fileInput = document.getElementById('img-file');
  const crop = document.getElementById('crop-box');
  const recognized = document.getElementById('recognized');
  const tagOCR = document.getElementById('tag-ocr');
  const bar = document.getElementById('ocr-bar');

  let imgLoaded=false, imgW=0, imgH=0, LOCKED=false;
  let rect = {x:0,y:0,w:0,h:0}, drag={mode:'none',dir:null,offsetX:0,offsetY:0};

  const clamp=(v,min,max)=> Math.max(min, Math.min(max,v));
  function showRect(r){ crop.style.display='block'; crop.style.left=r.x+'px'; crop.style.top=r.y+'px'; crop.style.width=r.w+'px'; crop.style.height=r.h+'px'; }
  function initRect(){ const W=imgEl.clientWidth,H=imgEl.clientHeight; const w=Math.round(W*0.84),h=Math.round(H*0.4); rect={x:Math.round((W-w)/2),y:Math.round((H-h)/2),w,h}; showRect(rect); }
  function rel(e){ const r=imgEl.getBoundingClientRect(); return { x: clamp(e.clientX-r.left,0,imgEl.clientWidth), y: clamp(e.clientY-r.top,0,imgEl.clientHeight) }; }
  function hitHandle(px,py){ const hs=crop.querySelectorAll('.handle'); for(const h of hs){ const b=h.getBoundingClientRect(); if(px>=b.left&&px<=b.right&&py>=b.top&&py<=b.bottom) return h.dataset.dir; } return null; }

  document.getElementById('btn-lock').onclick=()=>{ LOCKED=!LOCKED; document.getElementById('tag-lock').textContent='ì ê¸ˆ: '+(LOCKED?'ON':'í•´ì œ'); document.getElementById('btn-lock').textContent=LOCKED?'ğŸ”“ ì ê¸ˆ í•´ì œ':'ğŸ”’ ì ê¸ˆ'; };

  const wrap = document.getElementById('preview-wrap');
  wrap.addEventListener('pointerdown', e=>{
    if(!imgLoaded || LOCKED) return;
    const cb=crop.getBoundingClientRect(); const inside=e.clientX>=cb.left&&e.clientX<=cb.right&&e.clientY>=cb.top&&e.clientY<=cb.bottom;
    const dir=hitHandle(e.clientX,e.clientY);
    if(dir){ drag.mode='resize'; drag.dir=dir; }
    else if(inside){ drag.mode='move'; drag.offsetX=e.clientX-cb.left; drag.offsetY=e.clientY-cb.top; }
    else { const p=rel(e); rect={x:p.x,y:p.y,w:1,h:1}; showRect(rect); drag.mode='new'; }
    wrap.setPointerCapture?.(e.pointerId); e.preventDefault();
  });
  wrap.addEventListener('pointermove', e=>{
    if(!imgLoaded || drag.mode==='none' || LOCKED) return;
    const p=rel(e), W=imgEl.clientWidth, H=imgEl.clientHeight;
    if(drag.mode==='move'){ rect.x=clamp(p.x-drag.offsetX,0,W-rect.w); rect.y=clamp(p.y-drag.offsetY,0,H-rect.h); showRect(rect); }
    else if(drag.mode==='new'){ rect.w=clamp(p.x-rect.x,1,W-rect.x); rect.h=clamp(p.y-rect.y,1,H-rect.y); showRect(rect); }
    else if(drag.mode==='resize'){
      let x=rect.x,y=rect.y,w=rect.w,h=rect.h,d=drag.dir;
      if(d.includes('n')){ h+=(y-p.y); y=p.y; }
      if(d.includes('s')){ h=p.y-y; }
      if(d.includes('w')){ w+=(x-p.x); x=p.x; }
      if(d.includes('e')){ w=p.x-x; }
      if(w<24){ if(d.includes('w')) x=x+(w-24); w=24; }
      if(h<24){ if(d.includes('n')) y=y+(h-24); h=24; }
      x=clamp(x,0,W-24); y=clamp(y,0,H-24); w=clamp(w,24,W-x); h=clamp(h,24,H-y);
      rect={x,y,w,h}; showRect(rect);
    }
  });
  window.addEventListener('pointerup', e=>{ drag.mode='none'; drag.dir=null; try{wrap.releasePointerCapture?.(e.pointerId);}catch(_){}});

  // íŒŒì¼ ë¡œë“œ
  fileInput.addEventListener('change', e=>{
    const f=e.target.files&&e.target.files[0]; resetOutputs();
    if(!f){ imgLoaded=false; imgEl.style.display='none'; crop.style.display='none'; return; }
    const url=URL.createObjectURL(f);
    imgEl.onload=()=>{ imgW=imgEl.naturalWidth; imgH=imgEl.naturalHeight; imgLoaded=true; imgEl.style.display='block'; if(!LOCKED) initRect(); };
    imgEl.src=url;
  });
  function resetOutputs(){ recognized.textContent='(ëŒ€ê¸°)'; document.getElementById('tag-type').textContent='ìœ í˜•: -'; tagOCR.textContent='ì½ê¸°: ëŒ€ê¸°'; document.getElementById('result').style.display='none'; }

  // ---------- í¬ë¡­(ìœ—ì²¨ì ê°•í™”ë¥¼ ìœ„í•´ ìœ„ ì—¬ë°±â†‘ + ìŠ¤ì¼€ì¼â†‘) ----------
  function cropToCanvas(){
    if(!imgLoaded || rect.w<24 || rect.h<24){ alert('ë„¤ëª¨ë¥¼ ë” í¬ê²Œ ë§ì¶° ì£¼ì„¸ìš”.'); return null; }
    const padX=Math.round(rect.w*0.06), padTop=Math.round(rect.h*0.08), padBot=Math.round(rect.h*0.04);
    const rx=Math.max(0, rect.x - padX), ry=Math.max(0, rect.y - padTop);
    const rw=Math.min(imgEl.clientWidth-rx, rect.w+padX*2), rh=Math.min(imgEl.clientHeight-ry, rect.h+padTop+padBot);

    const sx=(imgEl.naturalWidth||imgW)/imgEl.clientWidth, sy=(imgEl.naturalHeight||imgH)/imgEl.clientHeight;
    const x=Math.round(rx*sx), y=Math.round(ry*sy), w=Math.round(rw*sx), h=Math.round(rh*sy);

    const c=document.createElement('canvas'); const scale=3.0; // ì œê³±(ìœ—ì²¨ì) ê°•í™”ë¥¼ ìœ„í•´ í¬ê²Œ
    c.width=Math.round(w*scale); c.height=Math.round(h*scale);
    const g=c.getContext('2d'); g.imageSmoothingEnabled=true; g.imageSmoothingQuality='high'; g.drawImage(imgEl, x,y,w,h, 0,0,c.width,c.height);
    return c;
  }

  // ---------- ìë™ íšŒì „(0/Â±90 ì¤‘ ìµœì ) ----------
  function rotateCanvas(cnv, deg){
    if(deg===0) return cnv;
    const r=document.createElement('canvas'), rad=deg*Math.PI/180;
    const w=cnv.width,h=cnv.height,diag=Math.ceil(Math.sqrt(w*w+h*h)); r.width=diag; r.height=diag;
    const ctx=r.getContext('2d'); ctx.translate(diag/2,diag/2); ctx.rotate(rad); ctx.drawImage(cnv, -w/2,-h/2);
    return r;
  }
  function autoOrientCanvas(cnv){
    try{
      if(typeof cv==='undefined') return cnv;
      const src=cv.imread(cnv), gray=new cv.Mat(), edges=new cv.Mat();
      cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY); cv.Canny(gray, edges, 60, 140, 3, false);
      const lines=new cv.Mat(); cv.HoughLinesP(edges, lines, 1, Math.PI/180, 80, 40, 8);
      let hCnt=0, vCnt=0;
      for(let i=0;i<lines.rows;i++){
        const p=lines.intPtr(i); const ang=Math.abs(Math.atan2(p[3]-p[1], p[2]-p[0])*(180/Math.PI));
        const a = ang>90? 180-ang: ang;
        if(a<=15) hCnt++; else if(Math.abs(a-90)<=15) vCnt++;
      }
      src.delete(); gray.delete(); edges.delete(); lines.delete();
      if(vCnt > hCnt*1.2) return rotateCanvas(cnv,-90);
      if(hCnt >= vCnt) return cnv;
      return rotateCanvas(cnv,90);
    }catch(e){ return cnv; }
  }

  // ---------- ì „ì²˜ë¦¬(íŒŒë€ê¸€ì”¨/í‘ë°± ìë™ ì‹œë„) ----------
  function preprocessBlue(cnv){
    try{
      if(typeof cv==='undefined') return cnv;
      const rgb=cv.imread(cnv); let hsv=new cv.Mat(); cv.cvtColor(rgb,hsv,cv.COLOR_RGBA2RGB); cv.cvtColor(hsv,hsv,cv.COLOR_RGB2HSV);
      const low=new cv.Mat(hsv.rows,hsv.cols,hsv.type(),[90,50,30,0]), high=new cv.Mat(hsv.rows,hsv.cols,hsv.type(),[135,255,255,255]);
      let mask=new cv.Mat(); cv.inRange(hsv,low,high,mask);
      // ì–‡ì€ íš ì‚´ë¦¬ê¸°
      let kernel=cv.Mat.ones(2,2,cv.CV_8U); cv.morphologyEx(mask,mask,cv.MORPH_OPEN,kernel); cv.morphologyEx(mask,mask,cv.MORPH_CLOSE,kernel); kernel.delete();
      // ë°˜ì „(ê²€ì€ ê¸€ì, í° ë°°ê²½)
      let inv=new cv.Mat(); cv.bitwise_not(mask, inv);
      const out=document.createElement('canvas'); out.width=inv.cols; out.height=inv.rows; cv.imshow(out,inv);
      rgb.delete(); hsv.delete(); mask.delete(); inv.delete(); low.delete(); high.delete();
      return out;
    }catch(e){ return cnv; }
  }
  function preprocessGray(cnv){
    try{
      if(typeof cv==='undefined') return cnv;
      let src=cv.imread(cnv), gray=new cv.Mat(), den=new cv.Mat(), th=new cv.Mat();
      cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
      // ëŒ€ë¹„ ê°•í™”(CLAHE ì‹œë„)
      try{ const clahe=cv.createCLAHE(2.0,new cv.Size(8,8)); clahe.apply(gray,gray); clahe.delete(); }catch(_){}
      cv.GaussianBlur(gray,den,new cv.Size(3,3),0);
      cv.threshold(den,th,0,255,cv.THRESH_BINARY+cv.THRESH_OTSU);
      // ì–‡ì€ ìœ—ì²¨ì êµµê²Œ
      let kernel=cv.Mat.ones(2,2,cv.CV_8U); cv.dilate(th, th, kernel); kernel.delete();
      const out=document.createElement('canvas'); out.width=th.cols; out.height=th.rows; cv.imshow(out,th);
      src.delete(); gray.delete(); den.delete(); th.delete();
      return out;
    }catch(e){ return cnv; }
  }

  // ---------- Tesseract ì›Œì»¤(ì¬ì‚¬ìš©) + ê³ DPI ----------
  let worker=null, workerLang='eng';
  async function ensureWorker(lang='eng'){
    if(worker && workerLang===lang) return worker;
    if(worker){ try{await worker.terminate();}catch(_){ } worker=null; }
    worker = await Tesseract.createWorker({ logger: m=>{ if(m.status==='recognizing text' && m.progress!=null){ bar.style.width=Math.round(m.progress*100)+'%'; } } });
    await worker.loadLanguage(lang);
    await worker.initialize(lang);
    workerLang = lang;
    await worker.setParameters({
      tessedit_pageseg_mode: 7,
      tessedit_char_whitelist: '0123456789xXyY()+-*/=<>&^.,â‰¤â‰¥<>|',
      tessedit_char_blacklist: '{}[]\\|`~;:"\'',
      user_defined_dpi: '420' // ì‘ì€ ìœ—ì²¨ì ì¸ì‹ ê°•í™”
    });
    return worker;
  }

  // ---------- ì˜¤ì¸ì‹/ìˆ˜í¼ìŠ¤í¬ë¦½íŠ¸ ë³´ì • ----------
  function fixSuperscripts(s){
    const map = {'â°':'^0','Â¹':'^1','Â²':'^2','Â³':'^3','â´':'^4','âµ':'^5','â¶':'^6','â·':'^7','â¸':'^8','â¹':'^9','âº':'+','â»':'-','â½':'(','â¾':')'};
    return (s||'').replace(/[â°-â¹âºâ»â½â¾]/g, ch => map[ch] || ch);
  }
  function inferCaretSafe(s){
    // ë³€ìˆ˜ ë’¤ 2/3ê°€ ë¶™ê³  ë‹¤ìŒì´ ì—°ì‚°ì/ëì´ë©´ x^2 í˜•íƒœë¡œ ë³´ì •
    return (s||'').replace(/([a-zA-Z])([23])(?=[$+\-*/=<>(),\s]|$)/g, (_,v,d)=> `${v}^${d}`);
  }
  function postClean(s, conf, lang){
    let t=(s||'')
      .replace(/\r/g,'')
      .replace(/[Â·Ã—]/g,'*')
      .replace(/[ï¼=]/g,'=')
      .replace(/[âˆ’â€“â€”]/g,'-')
      .replace(/ï¼¯/g,'0')
      .replace(/(?<=\d)[lI](?=\d)/g,'1');
    // ì ˆëŒ“ê°’ íŒŒì´í”„ ìœ ì§€
    const mathOnly = t.replace(/[^0-9a-zA-Zê°€-í£\s\(\)\+\-\*\/=<>&\^\,\.\u2264\u2265<>|]/g,'');
    const hasKor = /[ê°€-í£]/.test(mathOnly);
    const langPenalty = (lang==='eng' && hasKor)? -10 : 0;
    const bonus = (/\|x\|/.test(mathOnly)?10:0) + (/(=|â‰¤|â‰¥|<|>)/.test(mathOnly)?6:0) + (/(x|y)/i.test(mathOnly)?4:0) + (/x\^?2/.test(mathOnly)?4:0);
    return { clean:(mathOnly.trim()||t.trim()), score:(conf||0)+bonus+langPenalty };
  }

  // ---------- OCR: ë¹ ë¥¸ ê²½ë¡œ â†’ ë³´ì¡° ê²½ë¡œ ----------
  async function ocrFast(cnv){
    tagOCR.textContent='ì½ê¸°: ì§„í–‰ì¤‘(ë¹ ë¥¸)';
    const w=await ensureWorker('eng');
    const { data } = await w.recognize(cnv);
    let text = postClean(data.text||'', data.confidence||0, 'eng').clean;
    text = fixSuperscripts(text); text = inferCaretSafe(text);
    return text;
  }
  async function ocrDeep(cnv){
    tagOCR.textContent='ì½ê¸°: ë³´ì¡°';
    const w2=await ensureWorker('eng+kor');
    const { data } = await w2.recognize(cnv);
    let text = postClean(data.text||'', data.confidence||0, 'eng+kor').clean;
    text = fixSuperscripts(text); text = inferCaretSafe(text);
    return text;
  }

  // ---------- ë¶„ë¥˜/í’€ì´(ì ˆëŒ“ê°’ ì´ì°¨ í¬í•¨) ----------
  const resBox=document.getElementById('result'), stepsOl=document.getElementById('steps-ol'), summary=document.getElementById('summary'), verify=document.getElementById('verify');
  function cleanText(s){ return s.toLowerCase().replace(/\s+/g,' ').replace(/â‰¥/g,'>=').replace(/â‰¤/g,'<=').replace(/[â… l]/g,'1').replace(/ï¼¯/g,'0').trim(); }
  function detectType(t){
    const s=cleanText(t);
    if(/\|x\|/.test(s) && /(x\^?2|xÂ²)/.test(s) && /=\s*0/.test(s)) return 'absquad';
    if(/y\s*=/.test(s) && (s.match(/y\s*=/g)||[]).length>=2) return 'func';
    if(/[,;].*x.*y/.test(s) || /x\s*\+\s*y\s*=/.test(s)) return 'system';
    if(/(>=|<=|>|<)/.test(s) && /x/.test(s)) return 'ineq';
    if(/(x\^?2|xÂ²)/.test(s) && /=\s*0/.test(s)) return 'quadratic';
    if(/=\s*/.test(s) && /x/.test(s)) return 'linear';
    return 'unknown';
  }
  const gcd=(a,b)=>{a=Math.abs(a);b=Math.abs(b);while(b){[a,b]=[b,a%b]}return a||1};
  const frac=(n,d)=>{ if(d===0) return 'ì •ì˜X'; if(n===0) return '0'; const g=gcd(n,d); n/=g; d/=g; if(d<0){d*=-1;n*=-1} return d===1?`${n}`:`${n}/${d}`; };

  function renderResult(sum, steps, ver){
    resBox.style.display='block';
    summary.textContent=sum;
    const ol=document.getElementById('steps-ol'); ol.innerHTML='';
    steps.forEach(s=>{ const li=document.createElement('li'); li.textContent=s; ol.appendChild(li); });
    verify.innerHTML = ver && ver.includes('í†µê³¼') ? `<span class="ok">${ver}</span>` : (ver && ver!=='-' ? `<span class="warn">${ver}</span>` : '-');
    window.scrollTo({top:resBox.offsetTop-10,behavior:'smooth'});
  }

  function parseAbsQuad(s){
    const z=s.toLowerCase().replace(/xÂ²/g,'x^2').replace(/\s+/g,'');
    const m=z.match(/^([+\-]?\d*\.?\d*)x\^2([+\-]\d*\.?\d*)\|x\|([+\-]\d+\.?\d*)=0$/);
    if(!m) return null;
    const A=(m[1]===''||m[1]==='+')?1:(m[1]==='-'?-1:parseFloat(m[1]));
    const B=(m[2]===''||m[2]==='+')?1:(m[2]==='-'?-1:parseFloat(m[2]));
    const C=parseFloat(m[3]);
    return {A,B,C};
  }
  function solveAbsQuadEQ(eq){
    const {A,B,C}=eq, steps=[];
    steps.push(`y = |x| (yâ‰¥0)ë¡œ ë‘ë©´, ${A}yÂ² ${B>=0?'+':''}${B}y ${C>=0?'+':''}${C} = 0`);
    const D=B*B-4*A*C; steps.push(`íŒë³„ì‹ D = BÂ² - 4AC = ${D}`);
    if(D<0) return renderResult('ì‹¤ìˆ˜ í•´ ì—†ìŒ', steps, '-');
    const sD=Math.sqrt(D), y1=(-B+sD)/(2*A), y2=(-B-sD)/(2*A);
    steps.push(`y = (-B Â± âˆšD)/(2A) â‡’ y â‰ˆ ${y1.toFixed(6)}, ${y2.toFixed(6)} (yâ‰¥0ë§Œ ìœ íš¨)`);
    const ys=[y1,y2].filter(y=>y>=0); if(ys.length===0) return renderResult('ìœ íš¨í•œ y(=|x|) ì—†ìŒ', steps, '-');
    const xs=[]; ys.forEach(y=>{ xs.push(y); if(y!==0) xs.push(-y); });
    steps.push(`|x| = y ì´ë¯€ë¡œ x = Â±y`);
    renderResult(`ì •ë‹µ: x = ${xs.map(v=>Number.isInteger(v)?v:v.toFixed(6)).join(', ')}`, steps, 'ê²€ì‚° í†µê³¼');
  }

  function solveLinear(t){
    const m=t.match(/([+\-]?\d*\.?\d*)x(?:\s*([+\-]\s*\d+\.?\d*))?\s*=\s*([+\-]?\d+\.?\d*)/i); if(!m){ renderResult('1ì°¨ í•´ì„ ì‹¤íŒ¨',['ì‹ í™•ì¸'],'-'); return; }
    const A=(m[1]===''||m[1]==='+')?1:(m[1]==='-'?-1:parseFloat(m[1])), B=m[2]?parseFloat(m[2].replace(/\s+/g,'')):0, C=parseFloat(m[3]);
    const num=C-B, den=A, x=num/den;
    renderResult(`ì •ë‹µ: x = ${frac(num,den)}${Number.isFinite(x)&&!Number.isInteger(x)?` (â‰ˆ ${x.toFixed(6)})`:''}`, ['ìƒìˆ˜í•­ ì´ë™','ê³„ìˆ˜ë¡œ ë‚˜ëˆ”'], Math.abs(A*x+B-C)<1e-9?'ê²€ì‚° í†µê³¼':'ê²€ì‚° ì‹¤íŒ¨');
  }
  function solveQuadratic(t){
    const s2=t.replace(/xÂ²/g,'x^2').replace(/\s+/g,''), q=s2.match(/^([+\-]?\d*\.?\d*)x\^2([+\-]\d*\.?\d*)x([+\-]\d+\.?\d*)=0$/); if(!q){ renderResult('ì´ì°¨ í•´ì„ ì‹¤íŒ¨',['=0 í˜•íƒœ ê¶Œì¥'],'-'); return; }
    const A=(q[1]===''||q[1]==='+')?1:(q[1]==='-'?-1:parseFloat(q[1])), B=(q[2]===''||q[2]==='+')?1:(q[2]==='-'?-1:parseFloat(q[2])), C=parseFloat(q[3]);
    const D=B*B-4*A*C; if(D<0){ renderResult('ì‹¤ìˆ˜í•´ ì—†ìŒ',['D<0'],'-'); return; }
    const sD=Math.sqrt(D), x1=(-B+sD)/(2*A), x2=(-B-sD)/(2*A), f=x=>A*x*x+B*x+C;
    renderResult(`ì •ë‹µ: x â‰ˆ ${x1.toFixed(6)}, ${x2.toFixed(6)}`, ['í‘œì¤€í˜• í™•ì¸',`D=${D}`,'ê·¼ì˜ ê³µì‹'], (Math.abs(f(x1))<1e-6&&Math.abs(f(x2))<1e-6)?'ê²€ì‚° í†µê³¼':'ê²€ì‚° í™•ì¸ í•„ìš”');
  }
  function solveSystem(t){
    const parts=t.split(/[,;](?![^()]*\))/).map(v=>v.trim()); const re=/([+\-]?\d*\.?\d*)x\s*([+\-]\s*\d*\.?\d*)y\s*=\s*([+\-]?\d+\.?\d*)/;
    if(parts.length<2){ renderResult('ì—°ë¦½ í•´ì„ ì‹¤íŒ¨',['ì‰¼í‘œë¡œ ë‘ ì‹ êµ¬ë¶„'],'-'); return; }
    const m1=parts[0].match(re), m2=parts[1].match(re); if(!m1||!m2){ renderResult('ì—°ë¦½ í•´ì„ ì‹¤íŒ¨',['ì‹ í˜•íƒœ í™•ì¸'],'-'); return; }
    const n=v=>(v===''||v==='+')?1:(v==='-'?-1:parseFloat(v));
    const a1=n(m1[1]), b1=n((m1[2]||'').replace(/\s+/g,'')), c1=parseFloat(m1[3]);
    const a2=n(m2[1]), b2=n((m2[2]||'').replace(/\s+/g,'')), c2=parseFloat(m2[3]);
    const D=a1*b2-b1*a2; if(D===0){ renderResult('ìœ ì¼í•´ ì—†ìŒ',['Î”=0'],'-'); return; }
    const Dx=c1*b2-b1*c2, Dy=a1*c2-c1*a2; const x=Dx/D, y=Dy/D;
    renderResult(`ì •ë‹µ: (x, y) = (${x.toFixed(6)}, ${y.toFixed(6)})`,['Cramer ê³µì‹'], (Math.abs(a1*x+b1*y-c1)<1e-9 && Math.abs(a2*x+b2*y-c2)<1e-9)?'ê²€ì‚° í†µê³¼':'ê²€ì‚° ì‹¤íŒ¨');
  }
  function solveIneq(t){
    const m=t.replace(/\s+/g,'').match(/^([+\-]?\d*\.?\d*)x(?:([+\-]\d+\.?\d*))?(>=|<=|>|<)([+\-]?\d+\.?\d*)$/); if(!m){ renderResult('ë¶€ë“±ì‹ í•´ì„ ì‹¤íŒ¨',['ê¸°í˜¸(>,<,â‰¥,â‰¤) ë˜ë ·ì´'],'-'); return; }
    const A=(m[1]===''||m[1]==='+')?1:(m[1]==='-'?-1:parseFloat(m[1])), B=m[2]?parseFloat(m[2]):0, op=m[3], C=parseFloat(m[4]);
    const flip=A<0, op2= flip?({'>':'<','<':'>','>=':'<=','<=':'>='}[op]):op;
    renderResult(`ì •ë‹µ: x ${op2} ${frac(C-B,A)}`,['ì •ë¦¬',`${A}ë¡œ ë‚˜ëˆ”(ë¶€ë“±í˜¸ ${flip?'ë°˜ì „':'ìœ ì§€'})`], '-');
  }
  function solveFunc(t){
    const eqs=t.toLowerCase().split(/[,;](?![^()]*\))/).map(v=>v.trim()); const re=/y\s*=\s*([+\-]?\d*\.?\d*)x\s*([+\-]\s*\d+\.?\d*)?/;
    if(eqs.length<2){ renderResult('êµì  í•´ì„ ì‹¤íŒ¨',['y=â€¦ ë‘ ê°œë¥¼ ì‰¼í‘œë¡œ'],'-'); return; }
    const m1=eqs[0].match(re), m2=eqs[1].match(re); if(!m1||!m2){ renderResult('êµì  í•´ì„ ì‹¤íŒ¨',['ì‹ ë˜ë ·ì´'],'-'); return; }
    const Cc=m=>({k:(m[1]===''||m[1]==='+')?1:(m[1]==='-'?-1:parseFloat(m[1])), n:m[2]?parseFloat(m[2].replace(/\s+/g,'')):0});
    const f1=Cc(m1), f2=Cc(m2);
    if(f1.k===f2.k){ renderResult(f1.n===f2.n?'ë¬´ìˆ˜íˆ ë§ì€ í•´(ê°™ì€ ì§ì„ )':'í•´ ì—†ìŒ(í‰í–‰)',['ê¸°ìš¸ê¸° ë™ì¼'],'-'); return; }
    const x=(f2.n-f1.n)/(f1.k-f2.k), y=f1.k*x+f1.n;
    renderResult(`êµì : (x, y) = (${x.toFixed(6)}, ${y.toFixed(6)})`,['ë‘ y ê°™ê²Œ','x,y ê³„ì‚°'],'ê²€ì‚° í†µê³¼');
  }

  function solveFromText(t){
    const typ=detectType(t);
    document.getElementById('tag-type').textContent='ìœ í˜•: '+({absquad:'ì ˆëŒ“ê°’ ì´ì°¨',linear:'1ì°¨',quadratic:'ì´ì°¨',system:'ì—°ë¦½',ineq:'ë¶€ë“±ì‹',func:'í•¨ìˆ˜ êµì ',unknown:'ì•Œìˆ˜ì—†ìŒ'}[typ]||typ);
    document.getElementById('result').style.display='none';
    if(typ==='absquad'){ const eq=parseAbsQuad(t); if(!eq){ renderResult('ì ˆëŒ“ê°’ ì‹ í•´ì„ ì‹¤íŒ¨',['í˜•íƒœ í™•ì¸'],'-'); return; } return solveAbsQuadEQ(eq); }
    if(typ==='linear') return solveLinear(t);
    if(typ==='quadratic') return solveQuadratic(t);
    if(typ==='system') return solveSystem(t);
    if(typ==='ineq') return solveIneq(t);
    if(typ==='func') return solveFunc(t);
    renderResult('ìœ í˜• ìë™ íŒë‹¨ ì‹¤íŒ¨',['ë°•ìŠ¤ë¥¼ ë” íƒ€ì´íŠ¸/ë°ê²Œ ì¡°ì •'],'-');
  }

  // ì‹¤í–‰
  async function runSolve(){
    if(typeof _cropGuard==='function' && !_cropGuard()) return; // ì‹¤í–‰ ê°€ë“œ(í•«í”½ìŠ¤)
    // 1) í¬ë¡­ â†’ 2) ìë™ íšŒì „ â†’ 3) ì „ì²˜ë¦¬(íšŒìƒ‰â†’í•„ìš” ì‹œ íŒŒë‘) â†’ 4) OCR(ë¹ ë¥¸â†’ë³´ì¡°)
    let cnv=cropToCanvas(); if(!cnv) return;
    cnv = autoOrientCanvas(cnv);

    let pre = preprocessGray(cnv);
    let text = await ocrFast(pre);
    if(!text || detectType(text)==='unknown'){
      pre = preprocessBlue(cnv);
      text = await ocrFast(pre);
      if(!text || detectType(text)==='unknown'){
        text = await ocrDeep(pre);
      }
    }

    recognized.textContent = text || '(ì—†ìŒ)';
    tagOCR.textContent = text ? 'ì½ê¸°: ì™„ë£Œ' : 'ì½ê¸°: ì‹¤íŒ¨';
    bar.style.width='0%';

    if(!text || detectType(text)==='unknown'){
      // í…ŒìŠ¤íŠ¸ ì‹ìœ¼ë¡œë¼ë„ íŒŒì´í”„ í™•ì¸(í•«í”½ìŠ¤)
      const t = 'x^2-3|x|-4=0';
      recognized.textContent = 'ì½ì€ ë‚´ìš©(í…ŒìŠ¤íŠ¸): ' + t;
      solveFromText(t);
      return;
    }
    solveFromText(text);
  }

  // ---------- í•«í”½ìŠ¤: ë²„íŠ¼-ì‹¤í–‰ ê°•ì œ ë°”ì¸ë”© + ìê°€ì§„ë‹¨ ----------
  function _showErr(err){
    console.error('[RUN ERROR]', err);
    const box = document.getElementById('recognized');
    if (box) box.textContent = 'ì˜¤ë¥˜: ' + (err?.message || err);
    alert('ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë‚¬ì–´ìš”. ë°•ìŠ¤ë¥¼ ë¬¸ì œì‹ì— ë”± ë§ì¶”ê³  ë‹¤ì‹œ ëˆŒëŸ¬ì£¼ì„¸ìš”.');
  }
  function _cropGuard(){
    try {
      const img = document.getElementById('img-preview');
      if (!img || img.style.display === 'none' || !img.src) {
        alert('ë¨¼ì € ì‚¬ì§„ì„ ì˜¬ë ¤ ì£¼ì„¸ìš”.');
        return false;
      }
      return true;
    } catch(_) { return true; }
  }
  function _quickSelfTest(){
    try{
      const t = 'x^2-3|x|-4=0';
      const rec = document.getElementById('recognized');
      if (rec) rec.textContent = 'ì½ì€ ë‚´ìš©(í…ŒìŠ¤íŠ¸): ' + t;
      solveFromText(t);
    }catch(e){ _showErr(e); }
  }
  function _bindSolve(){
    const btn = document.getElementById('btn-solve') || document.getElementById('nav-solve');
    if (!btn) return;
    btn.onclick = null;
    btn.addEventListener('click', async ()=>{
      try{
        if (!_cropGuard()) return;
        if (typeof runSolve === 'function') {
          const timeout = new Promise((_,rej)=> setTimeout(()=>rej(new Error('ì‹¤í–‰ íƒ€ì„ì•„ì›ƒ')), 8000));
          await Promise.race([runSolve(), timeout]).catch(_showErr);
        } else {
          _quickSelfTest();
        }
      }catch(e){ _showErr(e); }
    });
  }
  document.addEventListener('DOMContentLoaded', _bindSolve);
  setTimeout(_bindSolve, 1000);
  document.getElementById('nav-solve').onclick = ()=> document.getElementById('btn-solve').click();
  document.getElementById('nav-home').onclick = ()=> window.scrollTo({top:0,behavior:'smooth'});
  document.getElementById('nav-album').onclick= ()=> document.getElementById('img-file').click();
</script>

<script>
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=> navigator.serviceWorker.register('/math-coach/service-worker.js').catch(console.error));
  }
</script>
</body>
</html>
